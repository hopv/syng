--------------------------------------------------------------------------------
-- Prove the semantic soundness of the partial and total Hoare triples
--------------------------------------------------------------------------------

{-# OPTIONS --sized-types #-}

module Syho.Model.Hor.Sound where

open import Base.Size using (Size; âˆ; !)
open import Base.Func using (_$_; _â–·_; _â€º_)
open import Base.Few using (absurd)
open import Base.Prod using (_,_; -,_; âˆ‘-case)
open import Base.Nat using (â„•)
open import Base.List using (List; []; _âˆ·_; rep)
open import Syho.Lang.Expr using (Addr; _â‚’_; Type; Val; TyVal)
open import Syho.Lang.Ktxred using (Val/Ktxred)
open import Syho.Logic.Prop using (Prop'; _â†¦_; [âˆ—âˆˆâ±âŸ¨âŸ©]-syntax)
open import Syho.Logic.Core using (_Â»_; âˆƒâ‚-elim)
open import Syho.Logic.Ind using (â†ªâŸ¨âŸ©á´¾-use; â†ªâŸ¨âŸ©áµ€-use)
open import Syho.Logic.Hor using (_âŠ¢[_]âºâŸ¨_âŸ©á´¾_; _âŠ¢[_]âºâŸ¨_âŸ©áµ€[_]_; hor-áµ€â‡’á´¾; horáµ€-á¹¡;
  _áµ˜Â»Ê°_; _Ê°Â»áµ˜_; hor-frameË¡; hor-bind; hor-valáµ˜; hor-nd; horá´¾-â–¶; horáµ€-â–¶; hor-â—;
  hor-â)
open import Syho.Logic.Mem using (hor-ğŸ°; hor-â†; hor-alloc; hor-free)
open import Syho.Model.Prop.Base using (_âŠ¨_; âˆ—áµ’-monoË¡; âˆ—áµ’-monoÊ³; âˆ—áµ’âˆƒáµ’-out;
  [âˆ—áµ’âˆˆâ±âŸ¨âŸ©]-syntax)
open import Syho.Model.Prop.Mem using (_â†¦áµ’_)
open import Syho.Model.Prop.Interp using (â¸¨_â¸©)
open import Syho.Model.Prop.Sound using (âŠ¢-sem)
open import Syho.Model.Supd.Ind using (â†ªâŸ¨âŸ©á´¾áµ’-use; â†ªâŸ¨âŸ©áµ€áµ’-use)
open import Syho.Model.Supd.Interp using (â‡›á´µâ¿áµˆâ‡’â‡›áµ’; â‡›áµ’-mono; â‡›áµ’-eatË¡)
open import Syho.Model.Supd.Sound using (âŠ¢â‡›-sem)
open import Syho.Model.Hor.Wp using (âºâŸ¨_âŸ©á´¾áµ’[_]_; âºâŸ¨_âŸ©áµ€áµ’[_]_; âºâŸ¨âŸ©á´¾áµ’-val;
  âºâŸ¨âŸ©áµ€áµ’-val; âºâŸ¨âŸ©á´¾áµ’-mono; âºâŸ¨âŸ©áµ€áµ’-mono; âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©á´¾áµ’; â‡›áµ’-âºâŸ¨âŸ©á´¾áµ’; â‡›áµ’-âºâŸ¨âŸ©áµ€áµ’;
  âŠ¨âœ“â‡’âŠ¨-âºâŸ¨âŸ©á´¾áµ’; âŠ¨âœ“â‡’âŠ¨-âºâŸ¨âŸ©áµ€áµ’; âºâŸ¨âŸ©á´¾áµ’-â‡›áµ’; âºâŸ¨âŸ©áµ€áµ’-â‡›áµ’; âºâŸ¨âŸ©á´¾áµ’-eatË¡; âºâŸ¨âŸ©áµ€áµ’-eatË¡)
open import Syho.Model.Hor.Lang using (âŸ¨âŸ©á´¾áµ’-bind; âŸ¨âŸ©áµ€áµ’-bind; âºâŸ¨âŸ©á´¾áµ’-nd; âºâŸ¨âŸ©áµ€áµ’-nd;
  âºâŸ¨âŸ©á´¾áµ’-â–¶; âºâŸ¨âŸ©áµ€áµ’-â–¶; âºâŸ¨âŸ©á´¾áµ’-â—; âºâŸ¨âŸ©áµ€áµ’-â—; âºâŸ¨âŸ©á´¾áµ’-â; âºâŸ¨âŸ©áµ€áµ’-â)
open import Syho.Model.Hor.Mem using (âºâŸ¨âŸ©á´¾áµ’-ğŸ°; âºâŸ¨âŸ©áµ€áµ’-ğŸ°; âºâŸ¨âŸ©á´¾áµ’-â†; âºâŸ¨âŸ©áµ€áµ’-â†;
  âºâŸ¨âŸ©á´¾áµ’-alloc; âºâŸ¨âŸ©áµ€áµ’-alloc; âºâŸ¨âŸ©á´¾áµ’-free; âºâŸ¨âŸ©áµ€áµ’-free)

private variable
  Î¹ :  Size
  T :  Type
  P :  Prop' âˆ
  QË™ :  Val T â†’  Prop' âˆ
  vk :  Val/Ktxred T
  i k :  â„•
  Î¸ :  Addr
  áµ—vs :  List TyVal

--------------------------------------------------------------------------------
-- Lemmas on â†¦á´¸

abstract

  -- â¸¨ Î¸ â†¦á´¸ áµ—vs â¸© agrees with Î¸ â†¦á´¸áµ’ áµ—vs
  -- For induction we use the unfolded versions with âˆˆâ±âŸ¨ k âŸ©

  â†¦á´¸â‡’â†¦á´¸áµ’ :  â¸¨ [âˆ— (i , áµ—v) âˆˆâ±âŸ¨ k âŸ© áµ—vs ] Î¸ â‚’ i â†¦ áµ—v â¸©  âŠ¨
            [âˆ—áµ’ (i , áµ—v) âˆˆâ±âŸ¨ k âŸ© áµ—vs ] Î¸ â‚’ i â†¦áµ’ áµ—v
  â†¦á´¸â‡’â†¦á´¸áµ’ {áµ—vs = []} =  _
  â†¦á´¸â‡’â†¦á´¸áµ’ {áµ—vs = _ âˆ· áµ—vs'} =  âˆ—áµ’-monoÊ³ $ â†¦á´¸â‡’â†¦á´¸áµ’ {áµ—vs = áµ—vs'}

  â†¦á´¸áµ’â‡’â†¦á´¸ :  [âˆ—áµ’ (i , áµ—v) âˆˆâ±âŸ¨ k âŸ© áµ—vs ] Î¸ â‚’ i â†¦áµ’ áµ—v  âŠ¨
            â¸¨ [âˆ— (i , áµ—v) âˆˆâ±âŸ¨ k âŸ© áµ—vs ] Î¸ â‚’ i â†¦ áµ—v â¸©
  â†¦á´¸áµ’â‡’â†¦á´¸ {áµ—vs = []} _ =  absurd
  â†¦á´¸áµ’â‡’â†¦á´¸ {áµ—vs = _ âˆ· áµ—vs'} =  âˆ—áµ’-monoÊ³ $ â†¦á´¸áµ’â‡’â†¦á´¸ {áµ—vs = áµ—vs'}

--------------------------------------------------------------------------------
-- âŠ¢âºâŸ¨âŸ©áµ€-sem :  Semantic soundness of the total Hoare triple

abstract

  âŠ¢âºâŸ¨âŸ©áµ€-sem :
    P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’   â¸¨ P â¸©  âŠ¨  âºâŸ¨ vk âŸ©áµ€áµ’[ âˆ ]  Î» v â†’ â¸¨ QË™ v â¸©

  -- _Â»_ :  P âŠ¢[ âˆ ] Q â†’  Q âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ] RË™ â†’  P âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ] RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (PâŠ¢Q Â» QâŠ¢âŸ¨vkâŸ©R) =
    âŠ¨âœ“â‡’âŠ¨-âºâŸ¨âŸ©áµ€áµ’ Î» âœ“âˆ™ â†’ âŠ¢-sem PâŠ¢Q âœ“âˆ™ â€º âŠ¢âºâŸ¨âŸ©áµ€-sem QâŠ¢âŸ¨vkâŸ©R

  -- âˆƒâ‚-elim :  (âˆ€ x â†’  PË™ x âŠ¢[ âˆ ][ i ]â‡› Q) â†’  âˆƒâ‚Ë™ PË™ âŠ¢[ âˆ ][ i ]â‡› Q

  âŠ¢âºâŸ¨âŸ©áµ€-sem (âˆƒâ‚-elim PxâŠ¢âŸ¨vkâŸ©Q) =   âˆ‘-case Î» x â†’ âŠ¢âºâŸ¨âŸ©áµ€-sem (PxâŠ¢âŸ¨vkâŸ©Q x)

  -- â†ªâŸ¨âŸ©áµ€-use :  PË‚ .! âˆ— (PË‚ â†ªâŸ¨ e âŸ©áµ€[ i ] QË‚Ë™)
  --               âŠ¢[ âˆ ]âŸ¨ Â¡ e âŸ©áµ€[ á¹¡ i ]  Î» v â†’ QË‚Ë™ v .!
  ---- The counter increment á¹¡ i makes the recursive call of âŠ¢âºâŸ¨âŸ©áµ€-sem inductive

  âŠ¢âºâŸ¨âŸ©áµ€-sem â†ªâŸ¨âŸ©áµ€-use big =  â‡›áµ’-âºâŸ¨âŸ©áµ€áµ’ Î» _ â†’ big â–·
    âˆ—áµ’-monoÊ³ (â†ªâŸ¨âŸ©áµ€áµ’-use â€º â‡›á´µâ¿áµˆâ‡’â‡›áµ’) â–· â‡›áµ’-eatË¡ â–· â‡›áµ’-mono $ âˆ—áµ’âˆƒáµ’-out â€º Î» (-, big) â†’
    âˆ—áµ’âˆƒáµ’-out big â–· Î» (Pâˆ—RâŠ¢âŸ¨eâŸ©Q , PRa) â†’ âŠ¢âºâŸ¨âŸ©áµ€-sem Pâˆ—RâŠ¢âŸ¨eâŸ©Q PRa

  -- horáµ€-á¹¡ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’   P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ á¹¡ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (horáµ€-á¹¡ PâŠ¢âŸ¨vkâŸ©Q) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨vkâŸ©Q

  -- _áµ˜Â»Ê°_ :  P  âŠ¢[ âˆ ][ i ]â‡›  Q  â†’   Q  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  RË™  â†’
  --          P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (PâŠ¢â‡›Q áµ˜Â»Ê° QâŠ¢âŸ¨vkâŸ©R) Pa =  â‡›áµ’-âºâŸ¨âŸ©áµ€áµ’ Î» _ â†’ Pa â–· âŠ¢â‡›-sem PâŠ¢â‡›Q â–·
    â‡›áµ’-mono $ âŠ¢âºâŸ¨âŸ©áµ€-sem QâŠ¢âŸ¨vkâŸ©R

  -- _Ê°Â»áµ˜_ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’
  --          (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ][ i ]â‡›  RË™ v)  â†’
  --          P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (PâŠ¢âŸ¨vkâŸ©Q Ê°Â»áµ˜ QvâŠ¢â‡›Rv) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨vkâŸ©Q â€º
    âºâŸ¨âŸ©áµ€áµ’-mono (Î» v Qva _ â†’ âŠ¢â‡›-sem (QvâŠ¢â‡›Rv v) Qva) â€º âºâŸ¨âŸ©áµ€áµ’-â‡›áµ’

  -- hor-frameË¡ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’
  --               R  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  Î» v â†’  R  âˆ—  QË™ v

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-frameË¡ PâŠ¢âŸ¨vkâŸ©Q) =  âˆ—áµ’-monoÊ³ (âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨vkâŸ©Q ) â€º âºâŸ¨âŸ©áµ€áµ’-eatË¡

  -- hor-valáµ˜ :  P  âŠ¢[ âˆ ]â‡›  QË™ v  â†’   P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚€ v âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-valáµ˜ PâŠ¢â‡›Qv) Pa =  âºâŸ¨âŸ©áµ€áµ’-val Î» _ â†’ Pa â–· âŠ¢â‡›-sem PâŠ¢â‡›Qv

  -- hor-bind :  P  âŠ¢[ âˆ ]âŸ¨ e âŸ©áµ€[ i ]  QË™  â†’
  --             (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©áµ€[ i ]  RË™)  â†’
  --             P  âŠ¢[ âˆ ]âŸ¨ K á´·â— e âŸ©áµ€[ i ]  RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-bind PâŠ¢âŸ¨eâŸ©Q QvâŠ¢âŸ¨KvâŸ©R) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨eâŸ©Q â€º
    âºâŸ¨âŸ©áµ€áµ’-mono (Î» v â†’ âŠ¢âºâŸ¨âŸ©áµ€-sem (QvâŠ¢âŸ¨KvâŸ©R v)) â€º âŸ¨âŸ©áµ€áµ’-bind

  -- hor-nd :  {{Inh X}} â†’  (âˆ€(x : X) â†’  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ x âŸ©áµ€[ i ]  QË™)  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| ndá´¿) âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-nd PâŠ¢âŸ¨KxâŸ©Q) Pa =  âºâŸ¨âŸ©áµ€áµ’-nd Î» x â†’ Pa â–· âŠ¢âºâŸ¨âŸ©áµ€-sem (PâŠ¢âŸ¨KxâŸ©Q x)

  -- horáµ€-â–¶ :  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— eË‚ .! âŸ©áµ€[ i ]  QË™  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| â–¶á´¿ eË‚) âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (horáµ€-â–¶ PâŠ¢âŸ¨KeâŸ©Q) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨KeâŸ©Q â€º âºâŸ¨âŸ©áµ€áµ’-â–¶

  -- hor-â— :  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— eË™ x âŸ©áµ€[ i ]  QË™  â†’
  --          P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| eË™ â—á´¿ x) âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-â— PâŠ¢âŸ¨KexâŸ©Q) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨KexâŸ©Q â€º âºâŸ¨âŸ©áµ€áµ’-â—

  -- hor-â :  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— e âŸ©áµ€[ i ]  QË™  â†’
  --          P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| v âá´¿ e) âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-â PâŠ¢âŸ¨KeâŸ©Q) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨KeâŸ©Q â€º âºâŸ¨âŸ©áµ€áµ’-â

  -- hor-ğŸ° :  Î¸ â†¦âŸ¨ p âŸ© (-, v)  âˆ—  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©áµ€[ i ]  QË™  â†’
  --          Î¸ â†¦âŸ¨ p âŸ© (-, v)  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| ğŸ°á´¿ Î¸) âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-ğŸ° Î¸â†¦vâˆ—PâŠ¢âŸ¨KvâŸ©Q) =  âºâŸ¨âŸ©áµ€áµ’-ğŸ° $ âŠ¢âºâŸ¨âŸ©áµ€-sem Î¸â†¦vâˆ—PâŠ¢âŸ¨KvâŸ©Q

  -- hor-â† :  Î¸ â†¦ (-, v)  âˆ—  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ _ âŸ©áµ€[ i ]  QË™  â†’
  --          Î¸ â†¦ áµ—u  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| Î¸ â†á´¿ v) âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-â† Î¸â†¦vâˆ—PâŠ¢âŸ¨KâŸ©Q) =  âºâŸ¨âŸ©áµ€áµ’-â† $ âŠ¢âºâŸ¨âŸ©áµ€-sem Î¸â†¦vâˆ—PâŠ¢âŸ¨KâŸ©Q

  -- hor-alloc :
  --   (âˆ€ Î¸ â†’
  --     Î¸ â†¦á´¸ rep n âŠ¤á¹½  âˆ—  Free n Î¸  âˆ—  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ Î¸ âŸ©áµ€[ i ]  QË™)  â†’
  --   P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| allocá´¿ n) âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-alloc {n = n} Î¸â†¦âˆ—Freeâˆ—PâŠ¢âŸ¨KÎ¸âŸ©Q) =  âºâŸ¨âŸ©áµ€áµ’-alloc Î» Î¸ â†’
    âˆ—áµ’-monoË¡ (â†¦á´¸áµ’â‡’â†¦á´¸ {áµ—vs = rep n _}) â€º âŠ¢âºâŸ¨âŸ©áµ€-sem (Î¸â†¦âˆ—Freeâˆ—PâŠ¢âŸ¨KÎ¸âŸ©Q Î¸)

  -- hor-free :  len áµ—vs â‰¡ n  â†’   P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ _ âŸ©áµ€[ i ]  QË™  â†’
  --   Î¸ â†¦á´¸ áµ—vs  âˆ—  Free n Î¸  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| freeá´¿ Î¸) âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-free {áµ—vs} lenvsâ‰¡n PâŠ¢âŸ¨KâŸ©Q) =
    âˆ—áµ’-monoË¡ (â†¦á´¸â‡’â†¦á´¸áµ’ {áµ—vs = áµ—vs}) â€º âºâŸ¨âŸ©áµ€áµ’-free lenvsâ‰¡n (âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨KâŸ©Q)

--------------------------------------------------------------------------------
-- âŠ¢âºâŸ¨âŸ©á´¾-sem :  Semantic soundness of the partial Hoare triple

abstract

  âŠ¢âºâŸ¨âŸ©á´¾-sem :
    P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  QË™  â†’   â¸¨ P â¸©  âŠ¨  âºâŸ¨ vk âŸ©á´¾áµ’[ Î¹ ]  Î» v â†’ â¸¨ QË™ v â¸©

  -- _Â»_ :  P âŠ¢[ âˆ ] Q â†’  Q âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾ RË™ â†’  P âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾ RË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (PâŠ¢Q Â» QâŠ¢âŸ¨vkâŸ©R) =
    âŠ¨âœ“â‡’âŠ¨-âºâŸ¨âŸ©á´¾áµ’ Î» âœ“âˆ™ â†’ âŠ¢-sem PâŠ¢Q âœ“âˆ™ â€º âŠ¢âºâŸ¨âŸ©á´¾-sem QâŠ¢âŸ¨vkâŸ©R

  -- âˆƒâ‚-elim :  (âˆ€ x â†’  PË™ x âŠ¢[ âˆ ][ i ]â‡› Q) â†’  âˆƒâ‚Ë™ PË™ âŠ¢[ âˆ ][ i ]â‡› Q

  âŠ¢âºâŸ¨âŸ©á´¾-sem (âˆƒâ‚-elim PxâŠ¢âŸ¨vkâŸ©Q) =   âˆ‘-case Î» x â†’ âŠ¢âºâŸ¨âŸ©á´¾-sem (PxâŠ¢âŸ¨vkâŸ©Q x)

  -- â†ªâŸ¨âŸ©á´¾-use :  PË‚ .! âˆ— (PË‚ â†ªâŸ¨ e âŸ©á´¾ QË‚Ë™)  âŠ¢[ âˆ ]âŸ¨ â–¶ Â¡ e âŸ©á´¾  Î» v â†’ QË‚Ë™ v .!

  âŠ¢âºâŸ¨âŸ©á´¾-sem â†ªâŸ¨âŸ©á´¾-use big =  âºâŸ¨âŸ©á´¾áµ’-â–¶ Î»{ .! â†’ â‡›áµ’-âºâŸ¨âŸ©á´¾áµ’ Î» _ â†’ big â–·
    âˆ—áµ’-monoÊ³ (â†ªâŸ¨âŸ©á´¾áµ’-use â€º â‡›á´µâ¿áµˆâ‡’â‡›áµ’) â–· â‡›áµ’-eatË¡ â–· â‡›áµ’-mono $ âˆ—áµ’âˆƒáµ’-out â€º Î» (-, big) â†’
    âˆ—áµ’âˆƒáµ’-out big â–· Î» (Pâˆ—RâŠ¢âŸ¨eâŸ©Q , PRa) â†’ âŠ¢âºâŸ¨âŸ©á´¾-sem Pâˆ—RâŠ¢âŸ¨eâŸ©Q PRa }

  -- _áµ˜Â»Ê°_ :  P  âŠ¢[ âˆ ][ i ]â‡›  Q  â†’   Q  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  RË™  â†’
  --          P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  RË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (PâŠ¢â‡›Q áµ˜Â»Ê° QâŠ¢âŸ¨vkâŸ©R) Pa =  â‡›áµ’-âºâŸ¨âŸ©á´¾áµ’ Î» _ â†’ Pa â–· âŠ¢â‡›-sem PâŠ¢â‡›Q â–·
    â‡›áµ’-mono $ âŠ¢âºâŸ¨âŸ©á´¾-sem QâŠ¢âŸ¨vkâŸ©R

  -- _Ê°Â»áµ˜_ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  QË™  â†’
  --          (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ][ i ]â‡›  RË™ v)  â†’
  --          P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  RË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (PâŠ¢âŸ¨vkâŸ©Q Ê°Â»áµ˜ QvâŠ¢â‡›Rv) =  âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨vkâŸ©Q â€º
    âºâŸ¨âŸ©á´¾áµ’-mono (Î» v Qva _ â†’ âŠ¢â‡›-sem (QvâŠ¢â‡›Rv v) Qva) â€º âºâŸ¨âŸ©á´¾áµ’-â‡›áµ’

  -- hor-áµ€â‡’á´¾ :  P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©áµ€  QË™  â†’   P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-áµ€â‡’á´¾ PâŠ¢âŸ¨vkâŸ©Q) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨vkâŸ©Q â€º âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©á´¾áµ’

  -- hor-frameË¡ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  QË™  â†’
  --               R  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  Î» v â†’  R  âˆ—  QË™ v

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-frameË¡ PâŠ¢âŸ¨vkâŸ©Q) =  âˆ—áµ’-monoÊ³ (âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨vkâŸ©Q ) â€º âºâŸ¨âŸ©á´¾áµ’-eatË¡

  -- hor-valáµ˜ :  P  âŠ¢[ âˆ ]â‡›  QË™ v  â†’   P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚€ v âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-valáµ˜ PâŠ¢â‡›Qv) Pa =  âºâŸ¨âŸ©á´¾áµ’-val Î» _ â†’ Pa â–· âŠ¢â‡›-sem PâŠ¢â‡›Qv

  -- hor-bind :  P  âŠ¢[ âˆ ]âŸ¨ e âŸ©á´¾  QË™  â†’
  --             (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©á´¾  RË™)  â†’
  --             P  âŠ¢[ âˆ ]âŸ¨ K á´·â— e âŸ©á´¾  RË™

  -- Termination check fails if we include this, probably because hor-bind takes
  -- two partial Hoare triples as arguments
{-
  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-bind PâŠ¢âŸ¨eâŸ©Q QvâŠ¢âŸ¨KvâŸ©R) =  âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨eâŸ©Q â€º
    âºâŸ¨âŸ©á´¾áµ’-mono (Î» v â†’ âŠ¢âºâŸ¨âŸ©á´¾-sem (QvâŠ¢âŸ¨KvâŸ©R v)) â€º âŸ¨âŸ©á´¾áµ’-bind
-}

  -- hor-nd :  {{Inh X}} â†’  (âˆ€(x : X) â†’  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ x âŸ©á´¾  QË™)  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| ndá´¿) âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-nd PâŠ¢âŸ¨KxâŸ©Q) Pa =  âºâŸ¨âŸ©á´¾áµ’-nd Î» x â†’ Pa â–· âŠ¢âºâŸ¨âŸ©á´¾-sem (PâŠ¢âŸ¨KxâŸ©Q x)

  -- horá´¾-â–¶ :  P  âŠ¢[< âˆ ]âŸ¨ K á´·â— eË‚ .! âŸ©á´¾  QË™  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| â–¶á´¿ eË‚) âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (horá´¾-â–¶ PâŠ¢âŸ¨KeâŸ©Q) Pa =  âºâŸ¨âŸ©á´¾áµ’-â–¶ Î»{ .! â†’ âŠ¢âºâŸ¨âŸ©á´¾-sem (PâŠ¢âŸ¨KeâŸ©Q .!) Pa }

  -- hor-â— :  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— eË™ x âŸ©á´¾  QË™  â†’
  --          P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| eË™ â—á´¿ x) âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-â— PâŠ¢âŸ¨KexâŸ©Q) =  âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨KexâŸ©Q â€º âºâŸ¨âŸ©á´¾áµ’-â—

  -- hor-â :  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— e âŸ©á´¾  QË™  â†’
  --          P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| v âá´¿ e) âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-â PâŠ¢âŸ¨KeâŸ©Q) =  âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨KeâŸ©Q â€º âºâŸ¨âŸ©á´¾áµ’-â

  -- hor-ğŸ° :  Î¸ â†¦âŸ¨ p âŸ© (-, v)  âˆ—  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©á´¾  QË™  â†’
  --          Î¸ â†¦âŸ¨ p âŸ© (-, v)  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| ğŸ°á´¿ Î¸) âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-ğŸ° Î¸â†¦vâˆ—PâŠ¢âŸ¨KvâŸ©Q) =  âºâŸ¨âŸ©á´¾áµ’-ğŸ° $ âŠ¢âºâŸ¨âŸ©á´¾-sem Î¸â†¦vâˆ—PâŠ¢âŸ¨KvâŸ©Q

  -- hor-â† :  Î¸ â†¦ (-, v)  âˆ—  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ _ âŸ©á´¾  QË™  â†’
  --          Î¸ â†¦ áµ—u  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| Î¸ â†á´¿ v) âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-â† Î¸â†¦vâˆ—PâŠ¢âŸ¨KâŸ©Q) =  âºâŸ¨âŸ©á´¾áµ’-â† $ âŠ¢âºâŸ¨âŸ©á´¾-sem Î¸â†¦vâˆ—PâŠ¢âŸ¨KâŸ©Q

  -- hor-alloc :
  --   (âˆ€ Î¸ â†’  Î¸ â†¦á´¸ rep n âŠ¤á¹½  âˆ—  Free n Î¸  âˆ—  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ Î¸ âŸ©á´¾  QË™)  â†’
  --   P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| allocá´¿ n) âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-alloc {n = n} Î¸â†¦âˆ—Freeâˆ—PâŠ¢âŸ¨KÎ¸âŸ©Q) =  âºâŸ¨âŸ©á´¾áµ’-alloc Î» Î¸ â†’
    âˆ—áµ’-monoË¡ (â†¦á´¸áµ’â‡’â†¦á´¸ {áµ—vs = rep n _}) â€º âŠ¢âºâŸ¨âŸ©á´¾-sem (Î¸â†¦âˆ—Freeâˆ—PâŠ¢âŸ¨KÎ¸âŸ©Q Î¸)

  -- hor-free :  len áµ—vs â‰¡ n  â†’   P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ _ âŸ©á´¾  QË™  â†’
  --   Î¸ â†¦á´¸ áµ—vs  âˆ—  Free n Î¸  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (K á´·| freeá´¿ Î¸) âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-free {áµ—vs} lenvsâ‰¡n PâŠ¢âŸ¨KâŸ©Q) =
    âˆ—áµ’-monoË¡ (â†¦á´¸â‡’â†¦á´¸áµ’ {áµ—vs = áµ—vs}) â€º âºâŸ¨âŸ©á´¾áµ’-free lenvsâ‰¡n (âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨KâŸ©Q)
