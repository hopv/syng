--------------------------------------------------------------------------------
-- Proof rules on the Hoare triples
--------------------------------------------------------------------------------

{-# OPTIONS --without-K --sized-types #-}

module Syho.Logic.Hor where

open import Base.Func using (_$_; _âˆ˜_; id)
open import Base.Eq using (refl)
open import Base.Dec using (Inh)
open import Base.Size using (ğ•Š; !; _$áµ€Ê°_)
open import Base.Bool using (ğ”¹; tt; ff)
open import Base.Prod using (_,_; -,_)
open import Base.Sum using (Ä©â‚€_; Ä©â‚_)
open import Base.Nat using (â„•; _<áµˆ_; â‰¤áµˆ-refl; â‰¤áµˆá¹¡; _â‰¤_; _<_; â‰¤â‡’<â‰¡; â‰¤â‡’â‰¤áµˆ)
open import Base.Sety using (SetÊ¸; â¸¨_â¸©Ê¸)
open import Syho.Lang.Expr using (Type; â—¸Ê¸_; _Ê¸â†·_; Exprâˆ; ExprË‚âˆ; âˆ‡_; _â_; letË™;
  Vâ‡’E)
open import Syho.Lang.Ktxred using (Redex; ndá´¿; [_]á´¿âŸ¨_âŸ©; Ktx; â€¢á´·; _â—á´·Ê³_; _âá´·_;
  _á´·â—_; Val/Ktxred)
open import Syho.Lang.Reduce using (_â‡’á´¾_; _â‡’á´¾â—‹_; _â‡’á´¾â—_; redá´¾)
open import Syho.Logic.Prop using (WpKind; par; tot; Propâˆ; _âˆ—_; [âŠ¤]á´º)
open import Syho.Logic.Core using (_âŠ¢[_]_; â‡’<; _Â»_; âˆ—-comm)
open import Syho.Logic.Supd using (_âŠ¢[_][_]â‡›_; â‡’â‡›; â‡›-refl; â‡›â‡’â‡›á´º)

-- Import and re-export
open import Syho.Logic.Judg public using ([_]áµƒâŸ¨_âŸ©_; âºâŸ¨_âŸ©[_]_; _âŠ¢[_][_]áµƒâŸ¨_âŸ©_;
  _âŠ¢[<_][_]áµƒâŸ¨_âŸ©_; _âŠ¢[_]âºâŸ¨_âŸ©[_]_; _âŠ¢[_]âºâŸ¨_/_âŸ©[_]_; _âŠ¢[_]âºâŸ¨_âŸ©á´¾_; _âŠ¢[_]âºâŸ¨_âŸ©áµ€[_]_;
  _âŠ¢[<_]âºâŸ¨_âŸ©áµ€[_]_; _âŠ¢[_]âŸ¨_âŸ©[_]_; _âŠ¢[<_]âŸ¨_âŸ©[_]_; _âŠ¢[_]âŸ¨_âŸ©á´¾_; _âŠ¢[<_]âŸ¨_âŸ©á´¾_;
  _âŠ¢[_]âŸ¨_âŸ©áµ€[_]_; _âŠ¢[<_]âŸ¨_âŸ©áµ€[_]_; _âŠ¢[<á´¾_]âŸ¨_âŸ©[_]_; _âŠ¢[_][_]âºâŸ¨_âŸ©âˆ; _âŠ¢[<_][_]âºâŸ¨_âŸ©âˆ;
  _âŠ¢[_][_]âŸ¨_âŸ©âˆ; _âŠ¢[<_][_]âŸ¨_âŸ©âˆ; hor-áµ€â‡’á´¾; ihorâ‡’horá´¾; ahor-á¹¡; horáµ€-á¹¡; ihor-á¹¡;
  _áµ˜Â»áµƒÊ°_; _áµ˜á´ºÂ»Ê°_; _áµ˜á´ºÂ»â±Ê°_; _áµƒÊ°Â»áµ˜_; _Ê°Â»áµ˜á´º_; ahor-frameË¡; hor-frameË¡; ahorá´º-hor;
  ahorá´º-ihor; hor-bind; ihor-bind; hor-ihor-bind; hor-valáµ˜á´º; ahor-nd; hor-[];
  ihor-[]â—‹; ihor-[]â—; hor-fork; ihor-fork)

private variable
  Î¹ :  ğ•Š
  b :  ğ”¹
  i j :  â„•
  X :  Setâ‚€
  XÊ¸ :  SetÊ¸
  T U :  Type
  Îº :  WpKind
  P P' Q R :  Propâˆ
  QË™ Q'Ë™ RË™ :  X â†’ Propâˆ
  red :  Redex T
  vk :  Val/Ktxred T
  K :  Ktx T U
  e e' eâ‚€ :  Exprâˆ T
  e'Ë‚ :  ExprË‚âˆ T
  eË‚Ë™ :  X â†’ ExprË‚âˆ T
  v :  X

infixr -1 _áµ˜Â»Ê°_ _áµƒÊ°Â»_ _Ê°Â»áµ˜_ _Ê°Â»_

abstract

  ------------------------------------------------------------------------------
  -- Proof rules on the Hoare triples

  -->  hor-áµ€â‡’á´¾ :  P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©áµ€  QË™  â†’   P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©á´¾  QË™

  -->  ihorâ‡’horá´¾ :  P  âŠ¢[ Î¹ ][ i ]âºâŸ¨ vk âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©á´¾  QË™

  -->  hor-fork :  P  âŠ¢[<á´¾ Î¹ ]âŸ¨ K á´·â— âˆ‡ _ âŸ©[ Îº ]  RË™  â†’
  -->              Q  âŠ¢[<á´¾ Î¹ ]âŸ¨ e âŸ©[ Îº ] (Î» _ â†’  âŠ¤')  â†’
  -->              P  âˆ—  Q  âŠ¢[ Î¹ ]âºâŸ¨ Ä©â‚ (-, K , forká´¿ e) âŸ©[ Îº ]  RË™

  -->  ihor-fork :  P  âŠ¢[ Î¹ ][ i ]âŸ¨ K á´·â— âˆ‡ _ âŸ©âˆ  â†’
  -->               Q  âŠ¢[ Î¹ ]âŸ¨ e âŸ©áµ€[ j ] (Î» _ â†’  âŠ¤')  â†’
  -->               P  âˆ—  Q  âŠ¢[ Î¹ ][ i ]âºâŸ¨ Ä©â‚ (-, K , forká´¿ e) âŸ©âˆ

  -- Level increase on the atomic / total Hoare triple

  -->  ahor-á¹¡ :  P  âŠ¢[< Î¹ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’   P  âŠ¢[ Î¹ ][ á¹¡ i ]áµƒâŸ¨ red âŸ©  QË™

  ahor-<áµˆ :  i <áµˆ j  â†’   P  âŠ¢[< Î¹ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’
             P  âŠ¢[ Î¹ ][ j ]áµƒâŸ¨ red âŸ©  QË™
  ahor-<áµˆ â‰¤áµˆ-refl =  ahor-á¹¡
  ahor-<áµˆ (â‰¤áµˆá¹¡ i<j') =  ahor-á¹¡ âˆ˜ â‡’< âˆ˜ ahor-<áµˆ i<j'

  ahor-< :  i < j  â†’   P  âŠ¢[< Î¹ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’
            P  âŠ¢[ Î¹ ][ j ]áµƒâŸ¨ red âŸ©  QË™
  ahor-< =  ahor-<áµˆ âˆ˜ â‰¤â‡’â‰¤áµˆ

  ahor-â‰¤ :  i â‰¤ j  â†’   P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’
            P  âŠ¢[ Î¹ ][ j ]áµƒâŸ¨ red âŸ©  QË™
  ahor-â‰¤ iâ‰¤j  with â‰¤â‡’<â‰¡ iâ‰¤j
  â€¦ | Ä©â‚€ i<j =  ahor-< i<j âˆ˜ â‡’<
  â€¦ | Ä©â‚ refl =  id

  -->  horáµ€-á¹¡ :  P  âŠ¢[< Î¹ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’   P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©áµ€[ á¹¡ i ]  QË™

  horáµ€-<áµˆ :  i <áµˆ j  â†’   P  âŠ¢[< Î¹ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’
             P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©áµ€[ j ]  QË™
  horáµ€-<áµˆ â‰¤áµˆ-refl =  horáµ€-á¹¡
  horáµ€-<áµˆ (â‰¤áµˆá¹¡ i<j') =  horáµ€-á¹¡ âˆ˜ â‡’< âˆ˜ horáµ€-<áµˆ i<j'

  horáµ€-< :  i < j  â†’   P  âŠ¢[< Î¹ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’
            P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©áµ€[ j ]  QË™
  horáµ€-< =  horáµ€-<áµˆ âˆ˜ â‰¤â‡’â‰¤áµˆ

  horáµ€-â‰¤ :  i â‰¤ j  â†’   P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’
            P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©áµ€[ j ]  QË™
  horáµ€-â‰¤ iâ‰¤j  with â‰¤â‡’<â‰¡ iâ‰¤j
  â€¦ | Ä©â‚€ i<j =  horáµ€-< i<j âˆ˜ â‡’<
  â€¦ | Ä©â‚ refl =  id

  -->  ihor-á¹¡ :  P  âŠ¢[< Î¹ ][ i ]âºâŸ¨ vk âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ á¹¡ i ]âºâŸ¨ vk âŸ©âˆ

  ihor-<áµˆ :  i <áµˆ j  â†’   P  âŠ¢[< Î¹ ][ i ]âºâŸ¨ vk âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ j ]âºâŸ¨ vk âŸ©âˆ
  ihor-<áµˆ â‰¤áµˆ-refl =  ihor-á¹¡
  ihor-<áµˆ (â‰¤áµˆá¹¡ i<j') =  ihor-á¹¡ âˆ˜ â‡’< âˆ˜ ihor-<áµˆ i<j'

  ihor-< :  i < j  â†’   P  âŠ¢[< Î¹ ][ i ]âºâŸ¨ vk âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ j ]âºâŸ¨ vk âŸ©âˆ
  ihor-< =  ihor-<áµˆ âˆ˜ â‰¤â‡’â‰¤áµˆ

  ihor-â‰¤ :  i â‰¤ j  â†’   P  âŠ¢[ Î¹ ][ i ]âºâŸ¨ vk âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ j ]âºâŸ¨ vk âŸ©âˆ
  ihor-â‰¤ iâ‰¤j  with â‰¤â‡’<â‰¡ iâ‰¤j
  â€¦ | Ä©â‚€ i<j =  ihor-< i<j âˆ˜ â‡’<
  â€¦ | Ä©â‚ refl =  id

  -- Compose

  -->  _áµ˜Â»áµƒÊ°_ :  P  âŠ¢[ Î¹ ][ j ]â‡›  Q  â†’   Q  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ©  RË™  â†’
  -->            P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ©  RË™

  -->  _áµ˜á´ºÂ»Ê°_ :  P  âŠ¢[ Î¹ ][ i ]â‡›á´º  Q  â†’   Q  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  RË™  â†’
  -->            P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  RË™

  _áµ˜Â»Ê°_ :  P  âŠ¢[ Î¹ ][ i ]â‡›  Q  â†’   Q  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  RË™  â†’
           P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  RË™
  _áµ˜Â»Ê°_ =  _áµ˜á´ºÂ»Ê°_ âˆ˜ â‡›â‡’â‡›á´º

  -->  _áµ˜á´ºÂ»â±Ê°_ :  P  âŠ¢[ Î¹ ][ i ]â‡›á´º  Q  â†’   Q  âŠ¢[ Î¹ ][ j ]âºâŸ¨ vk âŸ©âˆ  â†’
  -->             P  âŠ¢[ Î¹ ][ j ]âºâŸ¨ vk âŸ©âˆ

  _áµ˜Â»â±Ê°_ :  P  âŠ¢[ Î¹ ][ i ]â‡›  Q  â†’   Q  âŠ¢[ Î¹ ][ j ]âºâŸ¨ vk âŸ©âˆ  â†’
            P  âŠ¢[ Î¹ ][ j ]âºâŸ¨ vk âŸ©âˆ
  _áµ˜Â»â±Ê°_ =  _áµ˜á´ºÂ»â±Ê°_ âˆ˜ â‡›â‡’â‡›á´º

  -->  _áµƒÊ°Â»áµ˜_ :  P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’
  -->            (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ][ j ]â‡›  RË™ v)  â†’
  -->            P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ©  RË™

  _áµƒÊ°Â»_ :  P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’   (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ]  RË™ v)  â†’
           P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ©  RË™
  PâŠ¢âŸ¨redâŸ©Q áµƒÊ°Â» âˆ€vQâŠ¢R =  PâŠ¢âŸ¨redâŸ©Q áµƒÊ°Â»áµ˜ Î» _ â†’ â‡’â‡› {i = 0} $ âˆ€vQâŠ¢R _

  -->  _Ê°Â»áµ˜á´º_ :  P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  QË™  â†’
  -->            (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ][ j ]â‡›á´º  RË™ v)  â†’
  -->            P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  RË™

  _Ê°Â»áµ˜_ :  P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  QË™  â†’   (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ][ j ]â‡›  RË™ v)  â†’
           P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  RË™
  _Ê°Â»áµ˜_ PâŠ¢âŸ¨vkâŸ©Q =  (PâŠ¢âŸ¨vkâŸ©Q Ê°Â»áµ˜á´º_) âˆ˜ (â‡›â‡’â‡›á´º âˆ˜_)

  _Ê°Â»_ :  P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  QË™  â†’   (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ]  RË™ v)  â†’
          P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  RË™
  PâŠ¢âŸ¨vkâŸ©Q Ê°Â» âˆ€vQâŠ¢R =  PâŠ¢âŸ¨vkâŸ©Q Ê°Â»áµ˜ Î» _ â†’ â‡’â‡› {i = 0} $ âˆ€vQâŠ¢R _

  -- Frame

  -->  ahor-frameË¡ :  P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’
  -->                 R  âˆ—  P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ© Î» v â†’  R  âˆ—  QË™ v

  ahor-frameÊ³ :  P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’
                 P  âˆ—  R  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ© Î» v â†’  QË™ v  âˆ—  R
  ahor-frameÊ³ PâŠ¢âŸ¨redâŸ©Q =  âˆ—-comm Â» ahor-frameË¡ PâŠ¢âŸ¨redâŸ©Q áµƒÊ°Â» Î» _ â†’ âˆ—-comm

  -->  hor-frameË¡ :  P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  QË™  â†’
  -->                R  âˆ—  P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ] Î» v â†’  R  âˆ—  QË™ v

  hor-frameÊ³ :  P  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ]  QË™  â†’
                P  âˆ—  R  âŠ¢[ Î¹ ]âºâŸ¨ vk âŸ©[ Îº ] Î» v â†’  QË™ v  âˆ—  R
  hor-frameÊ³ PâŠ¢âŸ¨vkâŸ©Q =  âˆ—-comm Â» hor-frameË¡ PâŠ¢âŸ¨vkâŸ©Q Ê°Â» Î» _ â†’ âˆ—-comm

  -- Compose an atomic Hoare triple and a Hoare triple on the context

  -->  ahorá´º-hor :  [âŠ¤]á´º âˆ— P  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ© (Î» v â†’  [âŠ¤]á´º âˆ— QË™ v)  â†’
  -->               (âˆ€ v â†’  QË™ v  âŠ¢[<á´¾ Î¹ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©[ Îº ]  RË™)  â†’
  -->               P  âŠ¢[ Î¹ ]âºâŸ¨ Ä©â‚ (-, K , red) âŸ©[ Îº ]  RË™

  ahor-hor :  P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ© (Î» v â†’  QË™ v)  â†’
              (âˆ€ v â†’  QË™ v  âŠ¢[<á´¾ Î¹ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©[ Îº ]  RË™)  â†’
              P  âŠ¢[ Î¹ ]âºâŸ¨ Ä©â‚ (-, K , red) âŸ©[ Îº ]  RË™
  ahor-hor PâŠ¢âŸ¨redâŸ©Qv =  ahorá´º-hor $ ahor-frameË¡ PâŠ¢âŸ¨redâŸ©Qv

  -->  ahorá´º-ihor :  [âŠ¤]á´º âˆ— P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ© (Î» v â†’  [âŠ¤]á´º âˆ— QË™ v)  â†’
  -->                (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ][ j ]âŸ¨ K á´·â— Vâ‡’E v âŸ©âˆ)  â†’
  -->                P  âŠ¢[ Î¹ ][ j ]âºâŸ¨ Ä©â‚ (-, K , red) âŸ©âˆ

  ahor-ihor :  P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ red âŸ© (Î» v â†’  QË™ v)  â†’
               (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ][ j ]âŸ¨ K á´·â— Vâ‡’E v âŸ©âˆ)  â†’
               P  âŠ¢[ Î¹ ][ j ]âºâŸ¨ Ä©â‚ (-, K , red) âŸ©âˆ
  ahor-ihor PâŠ¢âŸ¨redâŸ©Qv =  ahorá´º-ihor $ ahor-frameË¡ PâŠ¢âŸ¨redâŸ©Qv

  -- Value

  -->  hor-valáµ˜á´º :  P  âŠ¢[ Î¹ ][ i ]â‡›  QË™ v  â†’   P  âŠ¢[ Î¹ ]âºâŸ¨ T / Ä©â‚€ v âŸ©[ Îº ]  QË™

  hor-valáµ˜ :  P  âŠ¢[ Î¹ ][ i ]â‡›  QË™ v  â†’   P  âŠ¢[ Î¹ ]âºâŸ¨ T / Ä©â‚€ v âŸ©[ Îº ]  QË™
  hor-valáµ˜ =  hor-valáµ˜á´º âˆ˜ â‡›â‡’â‡›á´º

  hor-val :  P  âŠ¢[ Î¹ ]  QË™ v  â†’   P  âŠ¢[ Î¹ ]âºâŸ¨ T / Ä©â‚€ v âŸ©[ Îº ]  QË™
  hor-val PâŠ¢Q =  hor-valáµ˜ $ â‡’â‡› {i = 0} PâŠ¢Q

  -- Non-deterministic value

  -->  ahor-nd :  {{ Inh â¸¨ XÊ¸ â¸©Ê¸ }} â†’  P  âŠ¢[ Î¹ ][ i ]áµƒâŸ¨ ndá´¿ {XÊ¸} âŸ© Î» _ â†’  P

  hor-nd :  {{ Inh â¸¨ XÊ¸ â¸©Ê¸ }} â†’  (âˆ€ x â†’  P âŠ¢[<á´¾ Î¹ ]âŸ¨ K á´·â— âˆ‡ x âŸ©[ Îº ] QË™)  â†’
            P  âŠ¢[ Î¹ ]âºâŸ¨ Ä©â‚ (-, K , ndá´¿ {XÊ¸}) âŸ©[ Îº ]  QË™
  hor-nd {{InhX}} PâŠ¢âŸ¨KxâŸ©Q =  ahor-hor (ahor-nd {i = 0} {{InhX}}) Î» _ â†’ PâŠ¢âŸ¨KxâŸ©Q _

  -- Pure reduction

  -->  hor-[] :  P  âŠ¢[<á´¾ Î¹ ]âŸ¨ K á´·â— e âŸ©[ Îº ]  QË™  â†’
  -->            P  âŠ¢[ Î¹ ]âºâŸ¨ Ä©â‚ (-, K , [ e ]á´¿âŸ¨ b âŸ©) âŸ©[ Îº ]  QË™

  hor-â‡’á´¾ :  e â‡’á´¾ e'  â†’   P  âŠ¢[<á´¾ Î¹ ]âŸ¨ e' âŸ©[ Îº ]  QË™  â†’
            P  âŠ¢[ Î¹ ]âŸ¨ e âŸ©[ Îº ]  QË™
  hor-â‡’á´¾ (-, redá´¾ eâ‡’K[eâ‚€])  rewrite eâ‡’K[eâ‚€] =  hor-[]

  -->  ihor-[]â—‹ :  P  âŠ¢[ Î¹ ][ i ]âŸ¨ K á´·â— e âŸ©âˆ  â†’
  -->              P  âŠ¢[ Î¹ ][ i ]âºâŸ¨ Ä©â‚ (-, K , [ e ]á´¿â—‹) âŸ©âˆ

  -->  ihor-[]â— :  P  âŠ¢[< Î¹ ][ i ]âŸ¨ K á´·â— e âŸ©âˆ  â†’
  -->              P  âŠ¢[ Î¹ ][ i ]âºâŸ¨ Ä©â‚ (-, K , [ e ]á´¿â—) âŸ©âˆ

  ihor-[] :  P  âŠ¢[ Î¹ ][ i ]âŸ¨ K á´·â— e âŸ©âˆ  â†’
             P  âŠ¢[ Î¹ ][ i ]âºâŸ¨ Ä©â‚ (-, K , [ e ]á´¿âŸ¨ b âŸ©) âŸ©âˆ
  ihor-[] {b = ff} =  ihor-[]â—‹
  ihor-[] {b = tt} =  ihor-[]â— âˆ˜ â‡’<

  ihor-â‡’á´¾â—‹ :  e â‡’á´¾â—‹ e'  â†’   P  âŠ¢[ Î¹ ][ i ]âŸ¨ e' âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ i ]âŸ¨ e âŸ©âˆ
  ihor-â‡’á´¾â—‹ (redá´¾ eâ‡’K[eâ‚€])  rewrite eâ‡’K[eâ‚€] =  ihor-[]â—‹

  ihor-â‡’á´¾â— :  e â‡’á´¾â— e'  â†’   P  âŠ¢[< Î¹ ][ i ]âŸ¨ e' âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ i ]âŸ¨ e âŸ©âˆ
  ihor-â‡’á´¾â— (redá´¾ eâ‡’K[eâ‚€])  rewrite eâ‡’K[eâ‚€] =  ihor-[]â—

  ihor-â‡’á´¾ :  e â‡’á´¾ e'  â†’   P  âŠ¢[ Î¹ ][ i ]âŸ¨ e' âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ i ]âŸ¨ e âŸ©âˆ
  ihor-â‡’á´¾ (-, redá´¾ eâ‡’K[eâ‚€])  rewrite eâ‡’K[eâ‚€] =  ihor-[]

  -- Bind

  -->  hor-bind :  P  âŠ¢[ Î¹ ]âŸ¨ e âŸ©[ Îº ]  QË™  â†’
  -->              (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©[ Îº ]  RË™)  â†’
  -->              P  âŠ¢[ Î¹ ]âŸ¨ K á´·â— e âŸ©[ Îº ]  RË™

  -->  ihor-bind :  P  âŠ¢[ Î¹ ][ i ]âŸ¨ e âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ i ]âŸ¨ K á´·â— e âŸ©âˆ

  -->  hor-ihor-bind :  P  âŠ¢[ Î¹ ]âŸ¨ e âŸ©áµ€[ i ] QË™  â†’
  -->                   (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ][ j ]âŸ¨ K á´·â— Vâ‡’E v âŸ©âˆ)  â†’
  -->                   P  âŠ¢[ Î¹ ][ j ]âŸ¨ K á´·â— e âŸ©âˆ

  hor-â-bind :  P  âŠ¢[ Î¹ ]âŸ¨ e âŸ©[ Îº ]  QË™  â†’
                (âˆ€ v â†’  QË™ v  âŠ¢[<á´¾ Î¹ ]âŸ¨ e'Ë‚ .! âŸ©[ Îº ]  RË™)  â†’
                P  âŠ¢[ Î¹ ]âŸ¨ _â_ {T = T} e e'Ë‚ âŸ©[ Îº ]  RË™
  hor-â-bind {T = â—¸Ê¸ _} PâŠ¢âŸ¨eâŸ©Q QvâŠ¢âŸ¨e'âŸ©R =
    hor-bind {K = â€¢á´· âá´· _} PâŠ¢âŸ¨eâŸ©Q Î» v â†’ hor-[] $ QvâŠ¢âŸ¨e'âŸ©R v
  hor-â-bind {T = _ Ê¸â†· _} PâŠ¢âŸ¨eâŸ©Q QvâŠ¢âŸ¨e'âŸ©R =
    hor-bind {K = â€¢á´· âá´· _} PâŠ¢âŸ¨eâŸ©Q Î» v â†’ hor-[] $ QvâŠ¢âŸ¨e'âŸ©R v

  ihor-â-bind :  P  âŠ¢[ Î¹ ][ i ]âŸ¨ e âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ i ]âŸ¨ e â e'Ë‚ âŸ©âˆ
  ihor-â-bind =  ihor-bind {K = â€¢á´· âá´· _}

  hor-ihor-â-bind :  P  âŠ¢[ Î¹ ]âŸ¨ e âŸ©áµ€[ i ]  QË™  â†’
                     (âˆ€ v â†’  QË™ v  âŠ¢[ Î¹ ][ j ]âŸ¨ e'Ë‚ .! âŸ©âˆ)  â†’
                     P  âŠ¢[ Î¹ ][ j ]âŸ¨ _â_ {T = T} e e'Ë‚ âŸ©âˆ
  hor-ihor-â-bind {T = â—¸Ê¸ _} PâŠ¢âŸ¨eâŸ©Q QvâŠ¢âŸ¨e'âŸ©âˆ =
    hor-ihor-bind {K = â€¢á´· âá´· _} PâŠ¢âŸ¨eâŸ©Q Î» v â†’ ihor-[] $ QvâŠ¢âŸ¨e'âŸ©âˆ v
  hor-ihor-â-bind {T = _ Ê¸â†· _} PâŠ¢âŸ¨eâŸ©Q QvâŠ¢âŸ¨e'âŸ©âˆ =
    hor-ihor-bind {K = â€¢á´· âá´· _} PâŠ¢âŸ¨eâŸ©Q Î» v â†’ ihor-[] $ QvâŠ¢âŸ¨e'âŸ©âˆ v

  hor-let-bind :  P  âŠ¢[ Î¹ ]âŸ¨ eâ‚€ âŸ©[ Îº ]  QË™  â†’
                  (âˆ€ x â†’  QË™ x  âŠ¢[<á´¾ Î¹ ]âŸ¨ eË‚Ë™ x .! âŸ©[ Îº ]  RË™) â†’
                  P  âŠ¢[ Î¹ ]âŸ¨ letË™ eâ‚€ eË‚Ë™ âŸ©[ Îº ]  RË™
  hor-let-bind PâŠ¢âŸ¨eâ‚€âŸ©Q QxâŠ¢âŸ¨exâŸ©R =
    hor-bind {K = _ â—á´·Ê³ â€¢á´·} PâŠ¢âŸ¨eâ‚€âŸ©Q Î» x â†’ hor-[] $ QxâŠ¢âŸ¨exâŸ©R x

  ihor-let-bind :  P  âŠ¢[ Î¹ ][ i ]âŸ¨ eâ‚€ âŸ©âˆ  â†’   P  âŠ¢[ Î¹ ][ i ]âŸ¨ letË™ eâ‚€ eË‚Ë™ âŸ©âˆ
  ihor-let-bind =  ihor-bind {K = _ â—á´·Ê³ â€¢á´·}

  hor-ihor-let-bind :  P  âŠ¢[ Î¹ ]âŸ¨ eâ‚€ âŸ©áµ€[ i ]  QË™  â†’
                       (âˆ€ x â†’  QË™ x  âŠ¢[ Î¹ ][ j ]âŸ¨ eË‚Ë™ x .! âŸ©âˆ) â†’
                       P  âŠ¢[ Î¹ ][ j ]âŸ¨ letË™ eâ‚€ eË‚Ë™ âŸ©âˆ
  hor-ihor-let-bind PâŠ¢âŸ¨eâ‚€âŸ©Q QxâŠ¢âŸ¨exâŸ©âˆ =
    hor-ihor-bind {K = _ â—á´·Ê³ â€¢á´·} PâŠ¢âŸ¨eâ‚€âŸ©Q Î» x â†’ ihor-[] $ QxâŠ¢âŸ¨exâŸ©âˆ x

  -- Transform âŠ¢[<á´¾ ]âŸ¨ âŸ©[ ]

  hor<á´¾-map :  (âˆ€{Î¹'} â†’  P âŠ¢[ Î¹' ]âŸ¨ e âŸ©[ Îº ] QË™ â†’  P' âŠ¢[ Î¹' ]âŸ¨ e' âŸ©[ Îº ] Q'Ë™) â†’
               P âŠ¢[<á´¾ Î¹ ]âŸ¨ e âŸ©[ Îº ] QË™ â†’  P' âŠ¢[<á´¾ Î¹ ]âŸ¨ e' âŸ©[ Îº ] Q'Ë™
  hor<á´¾-map {Îº = par} PâŠ¢âŸ¨eâŸ©Qâ‡’P'âŠ¢âŸ¨e'âŸ©Q' =  PâŠ¢âŸ¨eâŸ©Qâ‡’P'âŠ¢âŸ¨e'âŸ©Q' $áµ€Ê°_
  hor<á´¾-map {Îº = tot _} PâŠ¢âŸ¨eâŸ©Qâ‡’P'âŠ¢âŸ¨e'âŸ©Q' =  PâŠ¢âŸ¨eâŸ©Qâ‡’P'âŠ¢âŸ¨e'âŸ©Q'
