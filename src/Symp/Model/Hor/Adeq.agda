--------------------------------------------------------------------------------
-- Adequacy of the semantic partial and total weakest preconditions
--------------------------------------------------------------------------------

{-# OPTIONS --without-K --sized-types #-}

module Symp.Model.Hor.Adeq where

open import Base.Level using (Level; 1á´¸; 3á´¸)
open import Base.Func using (_$_; _â–·_; _â€º_)
open import Base.Few using (âŠ¤; âŠ¥â‚€; absurd)
open import Base.Eq using (_â‰¡_; refl)
open import Base.Acc using (Acc; acc)
open import Base.Size using (ğ•Š; âˆ; ğ•Š'; sz; szâ»Â¹; _<Ë¢_; size<; !; Â§_;
  <Ë¢-wf)
open import Base.Bool using (tt; ff)
open import Base.Prod using (âˆ‘-syntax; _Ã—_; Ï€â‚€; Ï€â‚; _,_; -,_)
open import Base.Sum using (Ä©â‚€_; Ä©â‚_)
open import Base.Option using (Â¿_; Åˆ; Å¡_)
open import Base.List using (List; []; _âˆ·_; Â¿â‡’á´¸; _â§º_; _$á´¸_; _âˆˆá´¸_; âˆˆÊ°áµˆ; âˆˆáµ—Ë¡_;
  aug-refl; aug-âˆ·; _â‰ºá´°á´¹âŸ¨_âŸ©_; Rá´°á´¹; â‰ºá´°á´¹-hd; â‰ºá´°á´¹-tl; â‰ºá´°á´¹-wf)
open import Base.Sety using ()
open import Symp.Lang.Expr using (Type; â—¸_; Exprâˆ; Val; Vâ‡’E; Heap; âœ“á´´_)
open import Symp.Lang.Ktxred using (Ktxred; val/ktxred; val/ktxred-Ä©â‚€;
  val/ktxred-Vâ‡’E)
open import Symp.Lang.Reduce using ([]â‡’; redá´·á´¿; _â‡’á´·á´¿âˆ‘; redá´±; _â‡’áµ€_; _â‡’áµ€â—‹_; _â‡’áµ€â—_;
  redáµ€-hd; redáµ€-tl; _â‡’áµ€*_; â‡’áµ€*-refl; â‡’áµ€*-step; SNáµ€; Infáµ€; infáµ€)
open import Symp.Model.ERA.Glob using (Resá´³; _âœ“á´³_; Envá´µâ¿á´³; envá´³; âˆ…á´µâ¿á´³-âœ“á´º)
open import Symp.Model.Prop.Base using (SPropáµ’; Monoáµ’; _âŠ¨_; âŠ¨_; âˆƒáµ’-syntax;
  âŒœ_âŒáµ’; âŒœ_âŒáµ’Ã—_; âŠ¥áµ’â‚€; _âˆ—áµ’_; [âˆ—áµ’âˆˆ]-syntax; [âˆ—áµ’âˆˆÂ²]-syntax; Thunkáµ’; substáµ’;
  âŒœâŒáµ’-Mono; âˆ—áµ’â‡’âˆ—áµ’'; âˆ—áµ’'â‡’âˆ—áµ’; âˆ—áµ’-mono; âˆ—áµ’-monoË¡; âˆ—áµ’-monoÊ³; âˆ—áµ’-assocË¡; âˆ—áµ’-assocÊ³;
  ?âˆ—áµ’-comm; âˆ—áµ’?-intro; âˆ—áµ’-elimË¡; âˆ—áµ’-elimÊ³; [âˆ—áµ’]-Mono; [âˆ—áµ’âˆˆÂ²]-Mono; -âˆ—áµ’-applyË¡;
  â—-just; Shrunkáµ’âˆ—áµ’-out)
open import Symp.Model.Prop.Names using ([âŠ¤]á´ºáµ’)
open import Symp.Model.Fupd.Interp using (âŸ¨_âŸ©â‡›Ë¢âŸ¨_âŸ©_; Invá´³; Invá´³-âˆ…; â‡›Ë¢-Mono;
  â‡›Ë¢-monoâœ“; â‡›Ë¢-mono; âŠ¨âœ“â‡’âŠ¨-â‡›Ë¢; â‡›Ë¢-intro; â‡›Ë¢-join; â‡›Ë¢-eatË¡; â‡›Ë¢-eatÊ³; â‡›Ë¢-adeq;
  â‡›Ë¢-step)
open import Symp.Model.Hor.Wp using (âºâŸ¨_âŸ©á´¾áµ’; âŸ¨_âŸ©á´¾áµ’; âŸ¨_âŸ©áµ€áµ’; âŸ¨_âŸ©âˆáµ’; âŸ¨_âŸ©áµ€áµ’Ë‚;
  âŸ¨_âŸ©âˆáµ’Ë‚Ë¡; âŸ¨_âŸ©âˆáµ’Ë‚Ê³; âŸ¨_âŸ©á´¾áµ’âŠ¤; âŸ¨_âŸ©áµ€áµ’âŠ¤; âŸ¨Â¿_âŸ©á´¾áµ’âŠ¤Ë‚; âŸ¨Â¿_âŸ©áµ€áµ’âŠ¤Ë‚; âºâŸ¨âŸ©á´¾áµ’-valâ»Â¹; âºâŸ¨âŸ©á´¾áµ’-krâ»Â¹;
  âºâŸ¨âŸ©áµ€áµ’-krâ»Â¹; âºâŸ¨âŸ©âˆáµ’-krâ»Â¹; âºâŸ¨âŸ©á´¾áµ’-Mono; âºâŸ¨âŸ©á´¾áµ’âŠ¤-Mono; âºâŸ¨âŸ©áµ€áµ’-Mono; âºâŸ¨âŸ©âˆáµ’-Mono;
  âˆ€áµ’â‡›Ë¢-Mono; âºâŸ¨âŸ©á´¾áµ’âŠ¤â‡’âºâŸ¨âŸ©á´¾áµ’; âºâŸ¨âŸ©áµ€áµ’âŠ¤â‡’âºâŸ¨âŸ©áµ€áµ’; âºâŸ¨âŸ©á´¾áµ’â‡’âºâŸ¨âŸ©á´¾áµ’âŠ¤; âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©áµ€áµ’âŠ¤;
  âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©á´¾áµ’; âºâŸ¨âŸ©âˆáµ’â‡’âºâŸ¨âŸ©á´¾áµ’)

private variable
  Å‚ :  Level
  Î¹ Î¹â‚€ Î¹' :  ğ•Š
  Î¹s :  List (ğ•Š' 3á´¸)
  H H' :  Heap
  X :  Setâ‚€
  T :  Type
  eâº e e' :  Exprâˆ T
  eË‡ eË‡' :  Â¿ Exprâˆ (â—¸ âŠ¤)
  es es' :  List (Exprâˆ (â—¸ âŠ¤))
  v :  X
  kr :  Ktxred T
  Páµ’Ë™ :  X â†’ SPropáµ’ Å‚
  XË™ :  X â†’ Set Å‚
  Eá´µâ¿ :  Envá´µâ¿á´³
  a :  Resá´³

--------------------------------------------------------------------------------
-- Adequacy of the semantic partial weakest precondition

-- Separating conjunction of âŸ¨ âŸ©á´¾áµ’âŠ¤ âˆ over expressions of type â—¸ âŠ¤

[âˆ—áµ’]âŸ¨_âŸ©á´¾áµ’âŠ¤âˆ :  List (Exprâˆ (â—¸ âŠ¤)) â†’  SPropáµ’ 1á´¸
[âˆ—áµ’]âŸ¨ es âŸ©á´¾áµ’âŠ¤âˆ =  [âˆ—áµ’ e âˆˆ es ] âŸ¨ e âŸ©á´¾áµ’âŠ¤ âˆ

abstract

  -- Monoáµ’ for [âˆ—áµ’]âŸ¨ âŸ©á´¾áµ’âŠ¤âˆ

  [âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-Mono :  Monoáµ’ [âˆ—áµ’]âŸ¨ es âŸ©á´¾áµ’âŠ¤âˆ
  [âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-Mono {es = es} =  [âˆ—áµ’]-Mono {Páµ’s = (Î» e â†’ âŸ¨ e âŸ©á´¾áµ’âŠ¤ âˆ) $á´¸ es}

  -- Eliminate [âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ with âˆˆá´¸

  [âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-elim :  e âˆˆá´¸ es â†’  [âˆ—áµ’]âŸ¨ es âŸ©á´¾áµ’âŠ¤âˆ  âŠ¨  âŸ¨ e âŸ©á´¾áµ’âŠ¤ âˆ
  [âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-elim âˆˆÊ°áµˆ =  âˆ—áµ’-elimË¡ âºâŸ¨âŸ©á´¾áµ’âŠ¤-Mono
  [âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-elim {es = _ âˆ· es'} (âˆˆáµ—Ë¡ âˆˆes') =
    âˆ—áµ’-elimÊ³ ([âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-Mono {es = es'}) â€º [âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-elim âˆˆes'

  -- Lemma: If (e , es , H) â‡’áµ€ (e' , es' , H'),
  -- then âŸ¨ e âŸ©á´¾áµ’ âˆ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©á´¾áµ’âŠ¤âˆ entails
  -- âŸ¨ e' âŸ©á´¾áµ’ âˆ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©á´¾áµ’âŠ¤âˆ under âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ© with [âŠ¤]á´ºáµ’

  âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€ :  (e , es , H) â‡’áµ€ (e' , es' , H') â†’
    [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e âŸ©á´¾áµ’ âˆ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©á´¾áµ’âŠ¤âˆ  âŠ¨ âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ©
      [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e' âŸ©á´¾áµ’ âˆ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©á´¾áµ’âŠ¤âˆ
  âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€ (-, redáµ€-hd {es = es} (redá´± {eË‡ = eË‡} eâ‡’kr e'eË‡H'â‡))
    rewrite eâ‡’kr =  âˆ—áµ’-assocË¡ â€º âˆ—áµ’-monoË¡ (âŠ¨âœ“â‡’âŠ¨-â‡›Ë¢ Î» âœ“âˆ™ â†’ âˆ—áµ’-monoÊ³ âºâŸ¨âŸ©á´¾áµ’-krâ»Â¹ â€º
    -âˆ—áµ’-applyË¡ âˆ€áµ’â‡›Ë¢-Mono âœ“âˆ™ â€º (_$ _) â€º â‡›Ë¢-mono (Î» (-, big) â†’
    big _ _ _ _ e'eË‡H'â‡ â–· â‡›Ë¢-mono (âˆ—áµ’-monoÊ³ $ âˆ—áµ’-monoË¡ Î» big â†’ big .!)) â€º
    â‡›Ë¢-join) â€º â‡›Ë¢-eatÊ³ â€º â‡›Ë¢-mono $ âˆ—áµ’-assocÊ³ â€º âˆ—áµ’-monoÊ³ $ âˆ—áµ’-assocÊ³ â€º
    âˆ—áµ’-monoÊ³ $ go {eË‡}
   where
    go :  âŸ¨Â¿ eË‡' âŸ©á´¾áµ’âŠ¤Ë‚ âˆ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©á´¾áµ’âŠ¤âˆ  âŠ¨  [âˆ—áµ’]âŸ¨ Â¿â‡’á´¸ eË‡' â§º es âŸ©á´¾áµ’âŠ¤âˆ
    go {Åˆ} =  âˆ—áµ’-elimÊ³ $ [âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-Mono {es = es}
    go {Å¡ _} =  âˆ—áµ’-monoË¡ Î» big â†’ big .!
  âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€ (-, redáµ€-tl es'H'â‡esH) =  ?âˆ—áµ’-comm â€º âˆ—áµ’-monoÊ³
    (âˆ—áµ’-monoÊ³ (âˆ—áµ’-monoË¡ âºâŸ¨âŸ©á´¾áµ’âŠ¤â‡’âºâŸ¨âŸ©á´¾áµ’) â€º âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€ (-, es'H'â‡esH)) â€º
    â‡›Ë¢-eatË¡ â€º â‡›Ë¢-mono $ ?âˆ—áµ’-comm â€º âˆ—áµ’-monoÊ³ $ âˆ—áµ’-monoÊ³ $ âˆ—áµ’-monoË¡ âºâŸ¨âŸ©á´¾áµ’â‡’âºâŸ¨âŸ©á´¾áµ’âŠ¤

  -- Lemma: If (e , es , H) â‡’áµ€* (e' , es' , H'),
  -- then âŸ¨ e âŸ©á´¾áµ’ âˆ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©á´¾áµ’âŠ¤âˆ entails
  -- âŸ¨ e' âŸ©á´¾áµ’ âˆ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©á´¾áµ’âŠ¤âˆ under âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ© with [âŠ¤]á´ºáµ’

  âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€* :  (e , es , H) â‡’áµ€* (e' , es' , H') â†’
    [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e âŸ©á´¾áµ’ âˆ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©á´¾áµ’âŠ¤âˆ  âŠ¨ âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ©
      [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e' âŸ©á´¾áµ’ âˆ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©á´¾áµ’âŠ¤âˆ
  âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€* â‡’áµ€*-refl =  â‡›Ë¢-intro
  âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€* (â‡’áµ€*-step Hâ‡’áµ€M'' H''â‡’áµ€*H') =  âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€ Hâ‡’áµ€M'' â€º
    â‡›Ë¢-mono (âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€* H''â‡’áµ€*H') â€º â‡›Ë¢-join

  -- Postcondition: âŠ¨ âŸ¨ e âŸ©á´¾áµ’ âˆ Î» u â†’ âŒœ XË™ u âŒáµ’ ensures that the XË™ v holds for
  -- the result value v of any execution of (e , [] , H) for valid H

  âŸ¨âŸ©á´¾áµ’-post :  âŠ¨ âŸ¨ e âŸ©á´¾áµ’ âˆ (Î» u â†’ âŒœ XË™ u âŒáµ’) â†’  âœ“á´´ H â†’
               (e , [] , H) â‡’áµ€* (Vâ‡’E {T} v , es , H') â†’  XË™ v
  âŸ¨âŸ©á´¾áµ’-post âŠ¨âŸ¨eâŸ©X âœ“H eHâ‡’*vesH' =  â‡›Ë¢-adeq âœ“H $ âˆ—áµ’?-intro (âŠ¨âŸ¨eâŸ©X â–· âˆ—áµ’?-intro _) â€º
    âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€* eHâ‡’*vesH' â€º â‡›Ë¢-monoâœ“ (Î» âœ“âˆ™ â†’
    âˆ—áµ’-monoÊ³ (âˆ—áµ’-elimË¡ âºâŸ¨âŸ©á´¾áµ’-Mono â€º
    substáµ’ (Î» kr â†’ âºâŸ¨ kr âŸ©á´¾áµ’ âˆ _) (val/ktxred-Vâ‡’E) â€º âºâŸ¨âŸ©á´¾áµ’-valâ»Â¹) â€º
    -âˆ—áµ’-applyË¡ âˆ€áµ’â‡›Ë¢-Mono âœ“âˆ™ â€º (_$ _) â€º â‡›Ë¢-mono $ âˆ—áµ’-elimÊ³ âŒœâŒáµ’-Mono) â€º â‡›Ë¢-join

  -- Progress: If âŸ¨ e âŸ©á´¾áµ’ âˆ Páµ’Ë™ is a tautology, then any execution of
  -- (e , [] , H) never gets stuck for valid H

  -- For the main thread

  âŸ¨âŸ©á´¾áµ’-progress-main :  âŠ¨ âŸ¨ e âŸ©á´¾áµ’ âˆ Páµ’Ë™ â†’  âœ“á´´ H â†’
    (e , [] , H) â‡’áµ€* (e' , es , H') â†’  val/ktxred e' â‰¡ Ä©â‚ kr â†’  (kr , H') â‡’á´·á´¿âˆ‘
  âŸ¨âŸ©á´¾áµ’-progress-main âŠ¨âŸ¨eâŸ©P âœ“H eHâ‡’*e'esH' e'â‰¡kr =  â‡›Ë¢-adeq âœ“H $
    âˆ—áµ’?-intro (âŠ¨âŸ¨eâŸ©P â–· âˆ—áµ’?-intro _) â€º âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€* eHâ‡’*e'esH' â€º
    â‡›Ë¢-monoâœ“ (Î» âœ“âˆ™ â†’ âˆ—áµ’-monoÊ³ (âˆ—áµ’-elimË¡ âºâŸ¨âŸ©á´¾áµ’-Mono â€º
    substáµ’ (Î» kr â†’ âºâŸ¨ kr âŸ©á´¾áµ’ âˆ _) e'â‰¡kr â€º âºâŸ¨âŸ©á´¾áµ’-krâ»Â¹) â€º
    -âˆ—áµ’-applyË¡ âˆ€áµ’â‡›Ë¢-Mono âœ“âˆ™ â€º (_$ _) â€º â‡›Ë¢-mono Ï€â‚€) â€º â‡›Ë¢-join

  -- For forked threads

  âŸ¨âŸ©á´¾áµ’-progress-forked :
    âŠ¨ âŸ¨ e âŸ©á´¾áµ’ âˆ Páµ’Ë™ â†’  âœ“á´´ H â†’  (e , [] , H) â‡’áµ€* (e' , es , H') â†’  eâº âˆˆá´¸ es â†’
    val/ktxred eâº â‰¡ Ä©â‚ kr â†’  (kr , H') â‡’á´·á´¿âˆ‘
  âŸ¨âŸ©á´¾áµ’-progress-forked {es = es} âŠ¨âŸ¨eâŸ©P âœ“H eHâ‡’*e'esH' eâºâˆˆes eâºâ‰¡kr =  â‡›Ë¢-adeq âœ“H $
    âˆ—áµ’?-intro (âŠ¨âŸ¨eâŸ©P â–· âˆ—áµ’?-intro _) â€º âŸ¨âŸ©á´¾áµ’-[âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-â‡’áµ€* eHâ‡’*e'esH' â€º
    â‡›Ë¢-monoâœ“ (Î» âœ“âˆ™ â†’ âˆ—áµ’-monoÊ³ (âˆ—áµ’-elimÊ³ ([âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-Mono {es = es}) â€º
    [âˆ—áµ’]âŸ¨âŸ©á´¾áµ’âŠ¤âˆ-elim eâºâˆˆes â€º âºâŸ¨âŸ©á´¾áµ’âŠ¤â‡’âºâŸ¨âŸ©á´¾áµ’ â€º
    substáµ’ (Î» kr â†’ âºâŸ¨ kr âŸ©á´¾áµ’ âˆ _) eâºâ‰¡kr â€º âºâŸ¨âŸ©á´¾áµ’-krâ»Â¹) â€º
    -âˆ—áµ’-applyË¡ âˆ€áµ’â‡›Ë¢-Mono âœ“âˆ™ â€º (_$ _) â€º â‡›Ë¢-mono Ï€â‚€) â€º â‡›Ë¢-join

--------------------------------------------------------------------------------
-- Adequacy of the semantic total weakest precondition

-- Separating conjunction of âŸ¨ âŸ©áµ€áµ’âŠ¤ over expressions of type â—¸ âŠ¤ and sizes

[âˆ—áµ’]âŸ¨_âŸ©áµ€áµ’âŠ¤ :  List (Exprâˆ (â—¸ âŠ¤)) â†’  List (ğ•Š' 3á´¸) â†’  SPropáµ’ 1á´¸
[âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s =  [âˆ—áµ’ (e , sz Î¹) âˆˆÂ² es , Î¹s ] âŸ¨ e âŸ©áµ€áµ’âŠ¤ Î¹

abstract

  -- Monoáµ’ for [âˆ—áµ’]âŸ¨ âŸ©áµ€áµ’âŠ¤

  [âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-Mono :  Monoáµ’ $ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s
  [âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-Mono {es} =  [âˆ—áµ’âˆˆÂ²]-Mono {xs = es}

  -- Postcondition

  âŸ¨âŸ©áµ€áµ’-post :  âŠ¨ âŸ¨ e âŸ©áµ€áµ’ âˆ (Î» u â†’ âŒœ XË™ u âŒáµ’) â†’  âœ“á´´ H â†’
               (e , [] , H) â‡’áµ€* (Vâ‡’E v , es , H') â†’  XË™ v
  âŸ¨âŸ©áµ€áµ’-post âŠ¨âŸ¨eâŸ©X =  âŸ¨âŸ©á´¾áµ’-post $ Î»{a} â†’ âŠ¨âŸ¨eâŸ©X {a} â–· âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©á´¾áµ’

  -- Progress

  âŸ¨âŸ©áµ€áµ’-progress-main :  âŠ¨ âŸ¨ e âŸ©áµ€áµ’ âˆ Páµ’Ë™ â†’  âœ“á´´ H â†’
    (e , [] , H) â‡’áµ€* (e' , es , H') â†’  val/ktxred e' â‰¡ Ä©â‚ kr â†’  (kr , H') â‡’á´·á´¿âˆ‘
  âŸ¨âŸ©áµ€áµ’-progress-main âŠ¨âŸ¨eâŸ©P =  âŸ¨âŸ©á´¾áµ’-progress-main $ âŠ¨âŸ¨eâŸ©P â–· âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©á´¾áµ’

  âŸ¨âŸ©áµ€áµ’-progress-forked :
    âŠ¨ âŸ¨ e âŸ©áµ€áµ’ âˆ Páµ’Ë™ â†’  âœ“á´´ H â†’  (e , [] , H) â‡’áµ€* (e' , es , H') â†’  eâº âˆˆá´¸ es â†’
    val/ktxred eâº â‰¡ Ä©â‚ kr â†’  (kr , H') â‡’á´·á´¿âˆ‘
  âŸ¨âŸ©áµ€áµ’-progress-forked âŠ¨âŸ¨eâŸ©P =  âŸ¨âŸ©á´¾áµ’-progress-forked $ âŠ¨âŸ¨eâŸ©P â–· âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©á´¾áµ’

  -- Lemma: If (e , es , H) â‡’áµ€ (e' , es' , H'),
  -- then âŸ¨ e âŸ©áµ€áµ’ Î¹ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s entails
  -- âŸ¨ e' âŸ©áµ€áµ’ Î¹' Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©áµ€áµ’âŠ¤ Î¹s' under âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ© with [âŠ¤]á´ºáµ’
  -- for some Î¹', Î¹s' satisfying sz Î¹' âˆ· Î¹s' â‰ºá´°á´¹âŸ¨ _<Ë¢_ âŸ© sz Î¹ âˆ· Î¹s

  âŸ¨âŸ©áµ€áµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€ :  (e , es , H) â‡’áµ€ (e' , es' , H') â†’
    [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e âŸ©áµ€áµ’ Î¹ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s  âŠ¨ âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ©
      âˆƒáµ’ Î¹'âº , âˆƒáµ’ Î¹s' , âŒœ Î¹'âº âˆ· Î¹s' â‰ºá´°á´¹âŸ¨ _<Ë¢_ âŸ© sz Î¹ âˆ· Î¹s âŒáµ’Ã—
        [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e' âŸ©áµ€áµ’ (szâ»Â¹ Î¹'âº) Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©áµ€áµ’âŠ¤ Î¹s'
  âŸ¨âŸ©áµ€áµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€ (-, redáµ€-hd {es = es} (redá´± {eË‡ = eË‡} eâ‡’kr e'eË‡H'â‡))
    rewrite eâ‡’kr =  âˆ—áµ’-assocË¡ â€º âˆ—áµ’-monoË¡ (âŠ¨âœ“â‡’âŠ¨-â‡›Ë¢ Î» âœ“âˆ™ â†’ âˆ—áµ’-monoÊ³ âºâŸ¨âŸ©áµ€áµ’-krâ»Â¹ â€º
    -âˆ—áµ’-applyË¡ âˆ€áµ’â‡›Ë¢-Mono âœ“âˆ™ â€º (_$ _) â€º
    â‡›Ë¢-mono (Î» (-, big) â†’ big _ _ _ _ e'eË‡H'â‡) â€º â‡›Ë¢-join) â€º â‡›Ë¢-eatÊ³ â€º
    â‡›Ë¢-mono $ âˆ—áµ’-assocÊ³ â€º âˆ—áµ’-monoÊ³ (âˆ—áµ’-assocÊ³ â€º go {eË‡' = eË‡}) â€º âˆ—áµ’â‡’âˆ—áµ’' â€º
    Î»{ (-, -, bâˆ™câŠ‘a , [âŠ¤]b , -, -, Î¹'âˆ·Î¹s'â‰ºÎ¹âˆ·Î¹s , big) â†’
    -, -, Î¹'âˆ·Î¹s'â‰ºÎ¹âˆ·Î¹s , âˆ—áµ’'â‡’âˆ—áµ’ (-, -, bâˆ™câŠ‘a , [âŠ¤]b , big) }
   where
    go :  âŸ¨ e âŸ©áµ€áµ’Ë‚ Î¹ Páµ’Ë™ âˆ—áµ’ âŸ¨Â¿ eË‡' âŸ©áµ€áµ’âŠ¤Ë‚ Î¹ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s âŠ¨
            âˆƒáµ’ Î¹'âº , âˆƒáµ’ Î¹s' , âŒœ Î¹'âº âˆ· Î¹s' â‰ºá´°á´¹âŸ¨ _<Ë¢_ âŸ© sz Î¹ âˆ· Î¹s âŒáµ’Ã—
              âŸ¨ e âŸ©áµ€áµ’ (szâ»Â¹ Î¹'âº) Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ Â¿â‡’á´¸ eË‡' â§º es âŸ©áµ€áµ’âŠ¤ Î¹s'
    go {eË‡' = Åˆ} =  Shrunkáµ’âˆ—áµ’-out â€º Î»{ (Â§ big) â†’ -, -,
      â‰ºá´°á´¹-hd $ aug-âˆ· size< aug-refl ,
      big â–· âˆ—áµ’-monoÊ³ (âˆ—áµ’-elimÊ³ $ [âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-Mono {es}) }
    go {eË‡' = Å¡ _} =  Shrunkáµ’âˆ—áµ’-out â€º Î»{ (Â§ big) â†’ big â–· ?âˆ—áµ’-comm â–·
      Shrunkáµ’âˆ—áµ’-out â–· Î»{ (Â§ big) â†’ -, -,
      â‰ºá´°á´¹-hd $ aug-âˆ· size< $ aug-âˆ· size< aug-refl , big â–· ?âˆ—áµ’-comm }}
  âŸ¨âŸ©áµ€áµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€ {Î¹s = []} (-, redáµ€-tl _) =  âˆ—áµ’-assocË¡ â€º âˆ—áµ’â‡’âˆ—áµ’' â€º Î» ()
  âŸ¨âŸ©áµ€áµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€ {Î¹s = _ âˆ· _} (-, redáµ€-tl esHâ‡’) =  ?âˆ—áµ’-comm â€º
    âˆ—áµ’-monoÊ³ (âˆ—áµ’-monoÊ³ (âˆ—áµ’-monoË¡ âºâŸ¨âŸ©áµ€áµ’âŠ¤â‡’âºâŸ¨âŸ©áµ€áµ’) â€º âŸ¨âŸ©áµ€áµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€ (-, esHâ‡’)) â€º
    â‡›Ë¢-eatË¡ â€º â‡›Ë¢-mono $ âˆ—áµ’â‡’âˆ—áµ’' â€º Î» (-, -, âˆ™âŠ‘ , âŸ¨eâŸ©P , -, -, Î¹'âˆ·Î¹s'â‰º , big) â†’
    -, -, â‰ºá´°á´¹-tl Î¹'âˆ·Î¹s'â‰º ,
    âˆ—áµ’'â‡’âˆ—áµ’ (-, -, âˆ™âŠ‘ , âŸ¨eâŸ©P , big â–· âˆ—áµ’-monoÊ³ (âˆ—áµ’-monoË¡ âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©áµ€áµ’âŠ¤)) â–· ?âˆ—áµ’-comm

  -- Termination: âŠ¨ âŸ¨ e âŸ©áµ€áµ’ Î¹ Páµ’Ë™ ensures that (e , [] , H) is strongly
  -- normalizing, i.e., any execution of (e , [] , H) terminates, for valid H

  âŸ¨âŸ©áµ€áµ’â‡’SN :  âŠ¨ âŸ¨ e âŸ©áµ€áµ’ Î¹ Páµ’Ë™ â†’  âœ“á´´ H â†’  SNáµ€ (e , [] , H)
  âŸ¨âŸ©áµ€áµ’â‡’SN âŠ¨âŸ¨eâŸ©P âœ“H =  go {Î¹s = []} (â‰ºá´°á´¹-wf <Ë¢-wf) (âˆ…á´µâ¿á´³-âœ“á´º âœ“H) $
    â—-just â–· âˆ—áµ’?-intro (âˆ—áµ’?-intro _ âŠ¨âŸ¨eâŸ©P) â–· âˆ—áµ’?-intro Invá´³-âˆ…
   where
    -- Well-founded induction on sz Î¹ âˆ· Î¹s
    go :  Acc (Rá´°á´¹ _<Ë¢_) (sz Î¹ âˆ· Î¹s) â†’  envá´³ H Eá´µâ¿ âœ“á´³ a â†’
      (([âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e âŸ©áµ€áµ’ Î¹ Páµ’Ë™ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s) âˆ—áµ’ Invá´³ Eá´µâ¿) a  â†’
      SNáµ€ (e , es , H)
    go (acc â‰ºÎ¹âˆ·Î¹sâ‡’acc) HEâœ“a big =  acc Î» eesHâ‡’ â†’ big â–·
      âˆ—áµ’-monoË¡ (âŸ¨âŸ©áµ€áµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€ eesHâ‡’) â–· â‡›Ë¢-step HEâœ“a â–·
      Î» (-, -, H'E'âœ“b , big) â†’ âˆ—áµ’â‡’âˆ—áµ’' big â–·
      Î» (-, -, âˆ™âŠ‘ , (-, -, â‰ºÎ¹âˆ·Î¹s , big) , InvE') â†’
      go (â‰ºÎ¹âˆ·Î¹sâ‡’acc â‰ºÎ¹âˆ·Î¹s) H'E'âœ“b $ âˆ—áµ’'â‡’âˆ—áµ’ (-, -, âˆ™âŠ‘ , big , InvE')

--------------------------------------------------------------------------------
-- Adequacy of the semantic infinite weakest precondition

abstract

  -- Progress
  -- The main thread never becomes a value

  âŸ¨âŸ©âˆáµ’-progress-main :
    âŠ¨ âŸ¨ e âŸ©âˆáµ’ Î¹ âˆ â†’  âœ“á´´ H â†’  (e , [] , H) â‡’áµ€* (e' , es , H') â†’
    âˆ‘ kr ,  val/ktxred e' â‰¡ Ä©â‚ kr  Ã—  (kr , H') â‡’á´·á´¿âˆ‘
  âŸ¨âŸ©âˆáµ’-progress-main {e' = e'} âŠ¨âŸ¨eâŸ©P âœ“H eHâ‡’* with val/ktxred e' |
    (Î»{v} â†’ val/ktxred-Ä©â‚€ {e = e'} {v}) | (Î»{kr} â†’ âŸ¨âŸ©á´¾áµ’-progress-main
    {Páµ’Ë™ = Î» _ â†’ âŠ¥áµ’â‚€} {kr = kr} (âºâŸ¨âŸ©âˆáµ’â‡’âºâŸ¨âŸ©á´¾áµ’ âŠ¨âŸ¨eâŸ©P) âœ“H eHâ‡’*)
  â€¦ | Ä©â‚€ v | â‡’e'â‡’v | _  rewrite â‡’e'â‡’v refl =  absurd $
    âŸ¨âŸ©á´¾áµ’-post {XË™ = Î» _ â†’ âŠ¥â‚€} (âºâŸ¨âŸ©âˆáµ’â‡’âºâŸ¨âŸ©á´¾áµ’ âŠ¨âŸ¨eâŸ©P) âœ“H eHâ‡’*
  â€¦ | Ä©â‚ kr | _ | â‡’krH'â‡’ =  -, refl , â‡’krH'â‡’ refl

  âŸ¨âŸ©âˆáµ’-progress-forked :
    âŠ¨ âŸ¨ e âŸ©âˆáµ’ Î¹ âˆ â†’  âœ“á´´ H â†’  (e , [] , H) â‡’áµ€* (e' , es , H') â†’  eâº âˆˆá´¸ es â†’
    val/ktxred eâº â‰¡ Ä©â‚ kr â†’  (kr , H') â‡’á´·á´¿âˆ‘
  âŸ¨âŸ©âˆáµ’-progress-forked âŠ¨âŸ¨eâŸ©P =
    âŸ¨âŸ©á´¾áµ’-progress-forked $ âŠ¨âŸ¨eâŸ©P â–· âºâŸ¨âŸ©âˆáµ’â‡’âºâŸ¨âŸ©á´¾áµ’ {Páµ’Ë™ = Î» _ â†’ âŠ¥áµ’â‚€}

  -- Lemma: If (e , es , H) â‡’áµ€â—‹ (e' , es' , H'),
  -- then âŸ¨ e âŸ©âˆáµ’ Î¹ Î¹â‚€ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s entails
  -- âŸ¨ e' âŸ©âˆáµ’ Î¹' Î¹â‚€ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©áµ€áµ’âŠ¤ Î¹s' under âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ© with [âŠ¤]á´ºáµ’
  -- for some Î¹', Î¹s' satisfying sz Î¹' âˆ· Î¹s' â‰ºá´°á´¹âŸ¨ _<Ë¢_ âŸ© sz Î¹ âˆ· Î¹s

  âŸ¨âŸ©âˆáµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€â—‹ :  (e , es , H) â‡’áµ€â—‹ (e' , es' , H') â†’
    [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e âŸ©âˆáµ’ Î¹ Î¹â‚€ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s  âŠ¨ âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ©
      âˆƒáµ’ Î¹'âº , âˆƒáµ’ Î¹s' , âŒœ Î¹'âº âˆ· Î¹s' â‰ºá´°á´¹âŸ¨ _<Ë¢_ âŸ© sz Î¹ âˆ· Î¹s âŒáµ’Ã—
        [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e' âŸ©âˆáµ’ (szâ»Â¹ Î¹'âº) Î¹â‚€ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©áµ€áµ’âŠ¤ Î¹s'
  âŸ¨âŸ©âˆáµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€â—‹ (redáµ€-hd {es = es} (redá´± {eË‡ = eË‡} eâ‡’kr e'eË‡H'â‡â—‹))
    rewrite eâ‡’kr =  âˆ—áµ’-assocË¡ â€º âˆ—áµ’-monoË¡ (âŠ¨âœ“â‡’âŠ¨-â‡›Ë¢ Î» âœ“âˆ™ â†’ âˆ—áµ’-monoÊ³ âºâŸ¨âŸ©âˆáµ’-krâ»Â¹ â€º
    -âˆ—áµ’-applyË¡ âˆ€áµ’â‡›Ë¢-Mono âœ“âˆ™ â€º (_$ _) â€º
    â‡›Ë¢-mono (Î» (-, big) â†’ big _ _ _ _ e'eË‡H'â‡â—‹) â€º â‡›Ë¢-join) â€º â‡›Ë¢-eatÊ³ â€º
    â‡›Ë¢-mono $ âˆ—áµ’-assocÊ³ â€º âˆ—áµ’-monoÊ³ (âˆ—áµ’-assocÊ³ â€º go {eË‡' = eË‡}) â€º âˆ—áµ’â‡’âˆ—áµ’' â€º
    Î»{ (-, -, bâˆ™câŠ‘a , [âŠ¤]b , -, -, Î¹'âˆ·Î¹s'â‰ºÎ¹âˆ·Î¹s , big) â†’
    -, -, Î¹'âˆ·Î¹s'â‰ºÎ¹âˆ·Î¹s , âˆ—áµ’'â‡’âˆ—áµ’ (-, -, bâˆ™câŠ‘a , [âŠ¤]b , big) }
   where
    go :  âŸ¨ e âŸ©âˆáµ’Ë‚Ë¡ Î¹ Î¹â‚€ âˆ—áµ’ âŸ¨Â¿ eË‡' âŸ©áµ€áµ’âŠ¤Ë‚ Î¹ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s âŠ¨
            âˆƒáµ’ Î¹'âº , âˆƒáµ’ Î¹s' , âŒœ Î¹'âº âˆ· Î¹s' â‰ºá´°á´¹âŸ¨ _<Ë¢_ âŸ© sz Î¹ âˆ· Î¹s âŒáµ’Ã—
              âŸ¨ e âŸ©âˆáµ’ (szâ»Â¹ Î¹'âº) Î¹â‚€ âˆ—áµ’ [âˆ—áµ’]âŸ¨ Â¿â‡’á´¸ eË‡' â§º es âŸ©áµ€áµ’âŠ¤ Î¹s'
    go {eË‡' = Åˆ} =  Shrunkáµ’âˆ—áµ’-out â€º Î»{ (Â§ big) â†’ -, -,
      â‰ºá´°á´¹-hd $ aug-âˆ· size< aug-refl ,
      big â–· âˆ—áµ’-monoÊ³ (âˆ—áµ’-elimÊ³ $ [âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-Mono {es}) }
    go {eË‡' = Å¡ _} =  Shrunkáµ’âˆ—áµ’-out â€º Î»{ (Â§ big) â†’ big â–· ?âˆ—áµ’-comm â–·
      Shrunkáµ’âˆ—áµ’-out â–· Î»{ (Â§ big) â†’ -, -,
      â‰ºá´°á´¹-hd $ aug-âˆ· size< $ aug-âˆ· size< aug-refl , big â–· ?âˆ—áµ’-comm }}
  âŸ¨âŸ©âˆáµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€â—‹ {Î¹s = []} (redáµ€-tl _) =  âˆ—áµ’-assocË¡ â€º âˆ—áµ’â‡’âˆ—áµ’' â€º Î» ()
  âŸ¨âŸ©âˆáµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€â—‹ {Î¹s = _ âˆ· _} (redáµ€-tl esHâ‡’) =  ?âˆ—áµ’-comm â€º
    âˆ—áµ’-monoÊ³ (âˆ—áµ’-monoÊ³ (âˆ—áµ’-monoË¡ âºâŸ¨âŸ©áµ€áµ’âŠ¤â‡’âºâŸ¨âŸ©áµ€áµ’) â€º âŸ¨âŸ©áµ€áµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€ (-, esHâ‡’)) â€º
    â‡›Ë¢-eatË¡ â€º â‡›Ë¢-mono $ âˆ—áµ’â‡’âˆ—áµ’' â€º Î» (-, -, âˆ™âŠ‘ , âŸ¨eâŸ©P , -, -, Î¹'âˆ·Î¹s'â‰º , big) â†’
    -, -, â‰ºá´°á´¹-tl Î¹'âˆ·Î¹s'â‰º ,
    âˆ—áµ’'â‡’âˆ—áµ’ (-, -, âˆ™âŠ‘ , âŸ¨eâŸ©P , big â–· âˆ—áµ’-monoÊ³ (âˆ—áµ’-monoË¡ âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©áµ€áµ’âŠ¤)) â–· ?âˆ—áµ’-comm

  -- Lemma: If (e , es , H) â‡’áµ€â— (e' , es' , H'),
  -- then âŸ¨ e âŸ©âˆáµ’ Î¹ Î¹â‚€ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s entails
  -- âŸ¨ e' âŸ©âˆáµ’ âˆ - âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©áµ€áµ’âŠ¤ Î¹s under âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ© with [âŠ¤]á´ºáµ’ and Thunkáµ’

  âŸ¨âŸ©âˆáµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€â— :  (e , es , H) â‡’áµ€â— (e' , es' , H') â†’
    [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e âŸ©âˆáµ’ Î¹ Î¹â‚€ âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s  âŠ¨ âŸ¨ H âŸ©â‡›Ë¢âŸ¨ H' âŸ©
      Thunkáµ’ (Î» Î¹â‚€' â†’ [âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e' âŸ©âˆáµ’ âˆ Î¹â‚€' âˆ—áµ’ [âˆ—áµ’]âŸ¨ es' âŸ©áµ€áµ’âŠ¤ Î¹s) Î¹â‚€
  âŸ¨âŸ©âˆáµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€â— (redáµ€-hd (redá´± eâ‡’kr (redá´·á´¿ []â‡’)))  rewrite eâ‡’kr =
    âˆ—áµ’-assocË¡ â€º âˆ—áµ’-monoË¡ (âŠ¨âœ“â‡’âŠ¨-â‡›Ë¢ Î» âœ“âˆ™ â†’ âˆ—áµ’-monoÊ³ âºâŸ¨âŸ©âˆáµ’-krâ»Â¹ â€º
    -âˆ—áµ’-applyË¡ âˆ€áµ’â‡›Ë¢-Mono âœ“âˆ™ â€º (_$ _) â€º
    â‡›Ë¢-mono (Î» (-, big) â†’ big _ _ _ _ (redá´·á´¿ []â‡’)) â€º â‡›Ë¢-join) â€º â‡›Ë¢-eatÊ³ â€º
    â‡›Ë¢-mono $ âˆ—áµ’-assocÊ³ â€º Î» big â†’ Î»{ .! â†’ big â–· âˆ—áµ’-monoÊ³
    (âˆ—áµ’-monoË¡ $ âˆ—áµ’-monoË¡ (Î» big â†’ big .!) â€º âˆ—áµ’-elimË¡ âºâŸ¨âŸ©âˆáµ’-Mono) }

  -- Infiniteness: âŠ¨ âŸ¨ e âŸ©âˆáµ’ Î¹ âˆ ensures that any execution of (e , [] , H)
  -- triggers the event an infinite number of times for valid H

  âŸ¨âŸ©âˆáµ’â‡’Inf :  âŠ¨ âŸ¨ e âŸ©âˆáµ’ Î¹ Î¹' â†’  âœ“á´´ H â†’  Infáµ€ Î¹' (e , [] , H)
  âŸ¨âŸ©âˆáµ’â‡’Inf âŠ¨âŸ¨eâŸ©âˆ âœ“H =  go {Î¹s = []} (â‰ºá´°á´¹-wf <Ë¢-wf) (âˆ…á´µâ¿á´³-âœ“á´º âœ“H) $
    â—-just â–· âˆ—áµ’?-intro (âˆ—áµ’?-intro _ âŠ¨âŸ¨eâŸ©âˆ) â–· âˆ—áµ’?-intro Invá´³-âˆ…
   where
    -- Well-founded induction on (Î¹' , sz Î¹ âˆ· Î¹s)
    go :  Acc (Rá´°á´¹ _<Ë¢_) (sz Î¹ âˆ· Î¹s) â†’  envá´³ H Eá´µâ¿ âœ“á´³ a â†’
      (([âŠ¤]á´ºáµ’ âˆ—áµ’ âŸ¨ e âŸ©âˆáµ’ Î¹ Î¹' âˆ—áµ’ [âˆ—áµ’]âŸ¨ es âŸ©áµ€áµ’âŠ¤ Î¹s) âˆ—áµ’ Invá´³ Eá´µâ¿) a  â†’
      Infáµ€ Î¹' (e , es , H)
    go (acc â‰ºÎ¹âˆ·Î¹sâ‡’acc) HEâœ“a big =  infáµ€ Î»{
      {b = ff} eesHâ‡’â—‹ â†’ big â–· âˆ—áµ’-monoË¡ (âŸ¨âŸ©âˆáµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€â—‹ eesHâ‡’â—‹) â–·
        â‡›Ë¢-step HEâœ“a â–· Î» (-, -, H'E'âœ“b , big) â†’ âˆ—áµ’â‡’âˆ—áµ’' big â–·
        Î» (-, -, âˆ™âŠ‘ , (-, -, â‰ºÎ¹âˆ·Î¹s , big) , InvE') â†’
        go (â‰ºÎ¹âˆ·Î¹sâ‡’acc â‰ºÎ¹âˆ·Î¹s) H'E'âœ“b $ âˆ—áµ’'â‡’âˆ—áµ’ (-, -, âˆ™âŠ‘ , big , InvE');
      {b = tt} eesHâ‡’â— .! â†’ big â–· âˆ—áµ’-monoË¡ (âŸ¨âŸ©âˆáµ’-[âˆ—áµ’]âŸ¨âŸ©áµ€áµ’âŠ¤-â‡’áµ€â— eesHâ‡’â—) â–·
        â‡›Ë¢-step HEâœ“a â–· Î» (-, -, H'E'âœ“b , big) â†’
        go (â‰ºá´°á´¹-wf <Ë¢-wf) H'E'âœ“b $ big â–· âˆ—áµ’-monoË¡ Î» big â†’ big .! }
