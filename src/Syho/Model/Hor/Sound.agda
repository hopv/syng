--------------------------------------------------------------------------------
-- Prove the semantic soundness of the atomic, partial and total Hoare triples
--------------------------------------------------------------------------------

{-# OPTIONS --without-K --sized-types #-}

module Syho.Model.Hor.Sound where

open import Base.Size using (Size; âˆ; !)
open import Base.Func using (_$_; _â–·_; _â€º_)
open import Base.Few using (absurd)
open import Base.Prod using (_,_; -,_; âˆ‘-case)
open import Base.Nat using (â„•)
open import Base.List using (List; []; _âˆ·_; rep)
open import Syho.Lang.Expr using (Addr; _â‚’_; Type; Val; TyVal)
open import Syho.Lang.Ktxred using (Redex; Val/Ktxred)
open import Syho.Lang.Reduce using (redá´¾)
open import Syho.Logic.Prop using (Propâˆ; _â†¦_; [âˆ—âˆˆâ±âŸ¨âŸ©]-syntax)
open import Syho.Logic.Core using (_Â»_; âˆƒ-elim)
open import Syho.Logic.Ind using (â†ªáµƒâŸ¨âŸ©-use; â†ªâŸ¨âŸ©á´¾-use; â†ªâŸ¨âŸ©áµ€-use)
open import Syho.Logic.Hor using (_âŠ¢[_][_]áµƒâŸ¨_âŸ©_; _âŠ¢[_]âºâŸ¨_âŸ©á´¾_; _âŠ¢[_]âºâŸ¨_âŸ©áµ€[_]_;
  hor-áµ€â‡’á´¾; ahor-á¹¡; horáµ€-á¹¡; _áµ˜Â»áµƒÊ°_; _áµ˜á´ºÂ»Ê°_; _áµƒÊ°Â»áµ˜_; _Ê°Â»áµ˜á´º_; ahor-frameË¡;
  hor-frameË¡; ahor-hor; hor-bind; hor-valáµ˜á´º; ahor-nd; hor-[]; hor-fork)
open import Syho.Logic.Mem using (ahor-ğŸ°; ahor-â†; ahor-fau; ahor-cas-tt;
  ahor-cas-ff; ahor-alloc; ahor-free)
open import Syho.Model.Prop.Base using (_âŠ¨_; [âˆ—áµ’âˆˆâ±âŸ¨âŸ©]-syntax; âˆ—áµ’-mono; âˆ—áµ’-monoË¡;
  âˆ—áµ’-monoÊ³; âˆ—áµ’-comm; âˆ—áµ’âˆƒáµ’-out; -âˆ—áµ’-intro)
open import Syho.Model.Prop.Mem using (_â†¦áµ’_)
open import Syho.Model.Prop.Interp using (â¸¨_â¸©)
open import Syho.Model.Prop.Sound using (âŠ¢-sem)
open import Syho.Model.Supd.Ind using (â†ªáµƒâŸ¨âŸ©áµ’-use; â†ªâŸ¨âŸ©áµ’-use)
open import Syho.Model.Supd.Interp using (â‡›á´µâ¿áµˆâ‡’â‡›áµ’; â‡›áµ’-mono; â‡›áµ’-eatË¡; â‡›á´ºáµ’-mono)
open import Syho.Model.Supd.Sound using (âŠ¢â‡›-sem; âŠ¢â‡›á´º-sem)
open import Syho.Model.Hor.Wp using (áµƒâŸ¨_âŸ©áµ’; âºâŸ¨_âŸ©á´¾áµ’; âºâŸ¨_âŸ©áµ€áµ’; âºâŸ¨âŸ©á´¾áµ’-val;
  âºâŸ¨âŸ©áµ€áµ’-val; âºâŸ¨âŸ©á´¾áµ’â‡’âºâŸ¨âŸ©á´¾áµ’âŠ¤; âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©áµ€áµ’âŠ¤; áµƒâŸ¨âŸ©áµ’-mono; âºâŸ¨âŸ©á´¾áµ’-mono; âºâŸ¨âŸ©áµ€áµ’-mono;
  âŠ¨âœ“â‡’âŠ¨-áµƒâŸ¨âŸ©áµ’; âŠ¨âœ“â‡’âŠ¨-âºâŸ¨âŸ©á´¾áµ’; âŠ¨âœ“â‡’âŠ¨-âºâŸ¨âŸ©áµ€áµ’; âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©á´¾áµ’; â‡›áµ’-áµƒâŸ¨âŸ©áµ’; â‡›á´ºáµ’-âºâŸ¨âŸ©á´¾áµ’; â‡›áµ’-âºâŸ¨âŸ©á´¾áµ’;
  â‡›á´ºáµ’-âºâŸ¨âŸ©áµ€áµ’; â‡›áµ’-âºâŸ¨âŸ©áµ€áµ’; áµƒâŸ¨âŸ©áµ’-â‡›áµ’; âºâŸ¨âŸ©á´¾áµ’-â‡›á´ºáµ’; âºâŸ¨âŸ©á´¾áµ’-â‡›áµ’; âºâŸ¨âŸ©áµ€áµ’-â‡›á´ºáµ’; âºâŸ¨âŸ©áµ€áµ’-â‡›áµ’;
  áµƒâŸ¨âŸ©áµ’-eatË¡; âºâŸ¨âŸ©á´¾áµ’-eatË¡; âºâŸ¨âŸ©áµ€áµ’-eatË¡)
open import Syho.Model.Hor.Lang using (áµƒâŸ¨âŸ©áµ’-âŸ¨âŸ©á´¾áµ’; áµƒâŸ¨âŸ©áµ’-âŸ¨âŸ©áµ€áµ’; âŸ¨âŸ©á´¾áµ’-bind;
  âŸ¨âŸ©áµ€áµ’-bind; áµƒâŸ¨âŸ©áµ’-nd; âºâŸ¨âŸ©á´¾áµ’-[]; âºâŸ¨âŸ©áµ€áµ’-[]; âºâŸ¨âŸ©á´¾áµ’-fork; âºâŸ¨âŸ©áµ€áµ’-fork)
open import Syho.Model.Hor.Mem using (áµƒâŸ¨âŸ©áµ’-ğŸ°; áµƒâŸ¨âŸ©áµ’-â†; áµƒâŸ¨âŸ©áµ’-fau; áµƒâŸ¨âŸ©áµ’-cas-tt;
  áµƒâŸ¨âŸ©áµ’-cas-ff; áµƒâŸ¨âŸ©áµ’-alloc; áµƒâŸ¨âŸ©áµ’-free)

private variable
  Î¹ :  Size
  X :  Setâ‚€
  T :  Type
  P :  Propâˆ
  QË™ :  X â†’  Propâˆ
  red :  Redex T
  vk :  Val/Ktxred T
  i k :  â„•
  Î¸ :  Addr
  áµ—vs :  List TyVal

--------------------------------------------------------------------------------
-- Lemmas on â†¦á´¸

abstract

  -- â¸¨ Î¸ â†¦á´¸ áµ—vs â¸© agrees with Î¸ â†¦á´¸áµ’ áµ—vs
  -- For induction we use the unfolded versions with âˆˆâ±âŸ¨ k âŸ©

  â†¦á´¸â‡’â†¦á´¸áµ’ :  â¸¨ [âˆ— (i , áµ—v) âˆˆâ±âŸ¨ k âŸ© áµ—vs ] Î¸ â‚’ i â†¦ áµ—v â¸©  âŠ¨
            [âˆ—áµ’ (i , áµ—v) âˆˆâ±âŸ¨ k âŸ© áµ—vs ] Î¸ â‚’ i â†¦áµ’ áµ—v
  â†¦á´¸â‡’â†¦á´¸áµ’ {áµ—vs = []} =  _
  â†¦á´¸â‡’â†¦á´¸áµ’ {áµ—vs = _ âˆ· áµ—vs'} =  âˆ—áµ’-monoÊ³ $ â†¦á´¸â‡’â†¦á´¸áµ’ {áµ—vs = áµ—vs'}

  â†¦á´¸áµ’â‡’â†¦á´¸ :  [âˆ—áµ’ (i , áµ—v) âˆˆâ±âŸ¨ k âŸ© áµ—vs ] Î¸ â‚’ i â†¦áµ’ áµ—v  âŠ¨
            â¸¨ [âˆ— (i , áµ—v) âˆˆâ±âŸ¨ k âŸ© áµ—vs ] Î¸ â‚’ i â†¦ áµ—v â¸©
  â†¦á´¸áµ’â‡’â†¦á´¸ {áµ—vs = []} _ =  absurd
  â†¦á´¸áµ’â‡’â†¦á´¸ {áµ—vs = _ âˆ· áµ—vs'} =  âˆ—áµ’-monoÊ³ $ â†¦á´¸áµ’â‡’â†¦á´¸ {áµ—vs = áµ—vs'}

--------------------------------------------------------------------------------
-- âŠ¢áµƒâŸ¨âŸ©-sem :  Semantic soundness of the atomic Hoare triple

abstract

  âŠ¢áµƒâŸ¨âŸ©-sem :  P  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’   â¸¨ P â¸©  âŠ¨ áµƒâŸ¨ red âŸ©áµ’ Î» v â†’  â¸¨ QË™ v â¸©

  -- _Â»_ :  P âŠ¢[ âˆ ] Q â†’  Q âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ© RË™ â†’  P âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ© RË™

  âŠ¢áµƒâŸ¨âŸ©-sem (PâŠ¢Q Â» QâŠ¢âŸ¨redâŸ©R) =  âŠ¨âœ“â‡’âŠ¨-áµƒâŸ¨âŸ©áµ’ Î» âœ“âˆ™ â†’ âŠ¢-sem PâŠ¢Q âœ“âˆ™ â€º âŠ¢áµƒâŸ¨âŸ©-sem QâŠ¢âŸ¨redâŸ©R

  -- âˆƒ-elim :  (âˆ€ x â†’  PË™ x âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ© QË™) â†’
  --           âˆƒË™ PË™ âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ© QË™

  âŠ¢áµƒâŸ¨âŸ©-sem (âˆƒ-elim PxâŠ¢âŸ¨vkâŸ©Q) =   âˆ‘-case Î» x â†’ âŠ¢áµƒâŸ¨âŸ©-sem (PxâŠ¢âŸ¨vkâŸ©Q x)

  -- â†ªáµƒâŸ¨âŸ©-use :  PË‚ .!  âˆ—  (PË‚ â†ª[ i ]áµƒâŸ¨ red âŸ© QË‚Ë™)
  --               âŠ¢[ âˆ ][ á¹¡ i ]áµƒâŸ¨ red âŸ© Î» v â†’  QË‚Ë™ v .!
  -- The level increment á¹¡ i makes the recursive call of âŠ¢áµƒâŸ¨âŸ©-sem inductive

  âŠ¢áµƒâŸ¨âŸ©-sem â†ªáµƒâŸ¨âŸ©-use =  âˆ—áµ’-monoÊ³ (â†ªáµƒâŸ¨âŸ©áµ’-use â€º â‡›á´µâ¿áµˆâ‡’â‡›áµ’) â€º â‡›áµ’-eatË¡ â€º
    â‡›áµ’-mono (âˆ—áµ’âˆƒáµ’-out â€º Î» (-, big) â†’ âˆ—áµ’âˆƒáµ’-out big â–· Î» (Pâˆ—RâŠ¢âŸ¨redâŸ©Q , PRa) â†’
    âŠ¢áµƒâŸ¨âŸ©-sem Pâˆ—RâŠ¢âŸ¨redâŸ©Q PRa) â€º â‡›áµ’-áµƒâŸ¨âŸ©áµ’

  -- _áµ˜Â»áµƒÊ°_ :  P  âŠ¢[ âˆ ][ j ]â‡›  Q  â†’   Q  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ©  RË™  â†’
  --           P  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ©  RË™

  âŠ¢áµƒâŸ¨âŸ©-sem (PâŠ¢â‡›Q áµ˜Â»áµƒÊ° QâŠ¢âŸ¨redâŸ©R) =  âŠ¢â‡›-sem PâŠ¢â‡›Q â€º
    â‡›áµ’-mono (âŠ¢áµƒâŸ¨âŸ©-sem QâŠ¢âŸ¨redâŸ©R) â€º â‡›áµ’-áµƒâŸ¨âŸ©áµ’

  -- _áµƒÊ°Â»áµ˜_ :  P  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’
  --           (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ][ j ]â‡›  RË™ v)  â†’
  --           P  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ©  RË™

  âŠ¢áµƒâŸ¨âŸ©-sem (PâŠ¢âŸ¨redâŸ©Q áµƒÊ°Â»áµ˜ QvâŠ¢â‡›Rv) =  âŠ¢áµƒâŸ¨âŸ©-sem PâŠ¢âŸ¨redâŸ©Q â€º
    áµƒâŸ¨âŸ©áµ’-mono (Î» v Qva â†’ âŠ¢â‡›-sem (QvâŠ¢â‡›Rv v) Qva) â€º áµƒâŸ¨âŸ©áµ’-â‡›áµ’

  -- ahor-á¹¡ :  P  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’   P  âŠ¢[ âˆ ][ á¹¡ i ]áµƒâŸ¨ red âŸ©  QË™

  âŠ¢áµƒâŸ¨âŸ©-sem (ahor-á¹¡ PâŠ¢âŸ¨redâŸ©Q) =  âŠ¢áµƒâŸ¨âŸ©-sem PâŠ¢âŸ¨redâŸ©Q

  -- ahor-frameË¡ :  P  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ©  QË™  â†’
  --                R  âˆ—  P  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ© Î» v â†’  R  âˆ—  QË™ v

  âŠ¢áµƒâŸ¨âŸ©-sem (ahor-frameË¡ PâŠ¢âŸ¨redâŸ©Q) =  âˆ—áµ’-monoÊ³ (âŠ¢áµƒâŸ¨âŸ©-sem PâŠ¢âŸ¨redâŸ©Q ) â€º áµƒâŸ¨âŸ©áµ’-eatË¡

  -- ahor-nd :  {{ Inh â¸¨ XÊ¸ â¸©Ê¸ }} â†’  P  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ ndá´¿ {XÊ¸} âŸ© Î» _ â†’  P

  âŠ¢áµƒâŸ¨âŸ©-sem ahor-nd =  áµƒâŸ¨âŸ©áµ’-nd

  -- ahor-ğŸ° :  Î¸ â†¦âŸ¨ p âŸ© (T , v)  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ ğŸ°á´¿_ {T} Î¸ âŸ© Î» u â†’
  --             âŒœ u â‰¡ v âŒâˆ§  Î¸ â†¦âŸ¨ p âŸ© (T , v)

  âŠ¢áµƒâŸ¨âŸ©-sem ahor-ğŸ° =  áµƒâŸ¨âŸ©áµ’-ğŸ°

  -- ahor-â† :  Î¸ â†¦ áµ—u  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ _â†á´¿_ {T} Î¸ v âŸ© Î» _ â†’  Î¸ â†¦ (T , v)

  âŠ¢áµƒâŸ¨âŸ©-sem ahor-â† =  áµƒâŸ¨âŸ©áµ’-â†

  -- ahor-fau :  Î¸ â†¦ (â—¸Ê¸ XÊ¸ , x)  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ fauá´¿ f Î¸ âŸ© Î» y â†’
  --               âŒœ y â‰¡ x âŒâˆ§  Î¸ â†¦ (-, f x)

  âŠ¢áµƒâŸ¨âŸ©-sem ahor-fau =  áµƒâŸ¨âŸ©áµ’-fau

  -- ahor-cas-tt :  Î¸ â†¦ (â—¸Ê¸ XÊ¸ , x)  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ casá´¿ Î¸ x y âŸ© Î» b â†’
  --                  âŒœ b â‰¡ tt âŒâˆ§  Î¸ â†¦ (-, y)

  âŠ¢áµƒâŸ¨âŸ©-sem ahor-cas-tt =  áµƒâŸ¨âŸ©áµ’-cas-tt

  -- ahor-cas-ff :  z â‰¢ x  â†’
  --   Î¸ â†¦âŸ¨ p âŸ© (â—¸Ê¸ XÊ¸ , z)  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ casá´¿ Î¸ x y âŸ© Î» b â†’
  --     âŒœ b â‰¡ ff âŒâˆ§  Î¸ â†¦âŸ¨ p âŸ© (-, z)

  âŠ¢áµƒâŸ¨âŸ©-sem (ahor-cas-ff zâ‰¢x) =  áµƒâŸ¨âŸ©áµ’-cas-ff zâ‰¢x

  -- ahor-alloc :  âŠ¤'  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ allocá´¿ n âŸ© Î» Î¸ â†’
  --                 Î¸ â†¦á´¸ rep n âŠ¤-  âˆ—  Free n Î¸

  âŠ¢áµƒâŸ¨âŸ©-sem (ahor-alloc {n = n}) _ =  áµƒâŸ¨âŸ©áµ’-alloc â–·
    áµƒâŸ¨âŸ©áµ’-mono Î» _ â†’ âˆ—áµ’-monoË¡ $ â†¦á´¸áµ’â‡’â†¦á´¸ {áµ—vs = rep n _}

  -- ahor-free :  len áµ—vs â‰¡ n  â†’
  --   Î¸ â†¦á´¸ áµ—vs  âˆ—  Free n Î¸  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ freeá´¿ Î¸ âŸ© Î» _ â†’  âŠ¤'

  âŠ¢áµƒâŸ¨âŸ©-sem (ahor-free {áµ—vs} lenvsâ‰¡n) =  âˆ—áµ’-monoË¡ (â†¦á´¸â‡’â†¦á´¸áµ’ {áµ—vs = áµ—vs}) â€º
    áµƒâŸ¨âŸ©áµ’-free lenvsâ‰¡n â€º áµƒâŸ¨âŸ©áµ’-mono Î» _ _ â†’ absurd

--------------------------------------------------------------------------------
-- âŠ¢âºâŸ¨âŸ©áµ€-sem :  Semantic soundness of the total Hoare triple

abstract

  âŠ¢âºâŸ¨âŸ©áµ€-sem :
    P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’   â¸¨ P â¸©  âŠ¨ âºâŸ¨ vk âŸ©áµ€áµ’ âˆ Î» v â†’  â¸¨ QË™ v â¸©

  -- _Â»_ :  P âŠ¢[ âˆ ] Q â†’  Q âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ] RË™ â†’  P âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ] RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (PâŠ¢Q Â» QâŠ¢âŸ¨vkâŸ©R) =
    âŠ¨âœ“â‡’âŠ¨-âºâŸ¨âŸ©áµ€áµ’ Î» âœ“âˆ™ â†’ âŠ¢-sem PâŠ¢Q âœ“âˆ™ â€º âŠ¢âºâŸ¨âŸ©áµ€-sem QâŠ¢âŸ¨vkâŸ©R

  -- âˆƒ-elim :  (âˆ€ x â†’  PË™ x âŠ¢[ âˆ ][ i ]â‡› Q) â†’  âˆƒË™ PË™ âŠ¢[ âˆ ][ i ]â‡› Q

  âŠ¢âºâŸ¨âŸ©áµ€-sem (âˆƒ-elim PxâŠ¢âŸ¨vkâŸ©Q) =   âˆ‘-case Î» x â†’ âŠ¢âºâŸ¨âŸ©áµ€-sem (PxâŠ¢âŸ¨vkâŸ©Q x)

  -- â†ªâŸ¨âŸ©áµ€-use :  PË‚ .! âˆ— (PË‚ â†ªâŸ¨ e âŸ©áµ€[ i ] QË‚Ë™)
  --               âŠ¢[ âˆ ]âŸ¨ Â¡ e âŸ©áµ€[ á¹¡ i ] Î» v â†’  QË‚Ë™ v .!
  -- The level increment á¹¡ i makes the recursive call of âŠ¢âºâŸ¨âŸ©áµ€-sem inductive

  âŠ¢âºâŸ¨âŸ©áµ€-sem â†ªâŸ¨âŸ©áµ€-use =  âˆ—áµ’-monoÊ³ (â†ªâŸ¨âŸ©áµ’-use â€º â‡›á´µâ¿áµˆâ‡’â‡›áµ’) â€º â‡›áµ’-eatË¡ â€º
    (â‡›áµ’-mono $ âˆ—áµ’âˆƒáµ’-out â€º Î» (-, big) â†’ âˆ—áµ’âˆƒáµ’-out big â–· Î» (Pâˆ—RâŠ¢âŸ¨eâŸ©Q , PRa) â†’
    âŠ¢âºâŸ¨âŸ©áµ€-sem Pâˆ—RâŠ¢âŸ¨eâŸ©Q PRa) â€º â‡›áµ’-âºâŸ¨âŸ©áµ€áµ’

  -- horáµ€-á¹¡ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’   P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ á¹¡ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (horáµ€-á¹¡ PâŠ¢âŸ¨vkâŸ©Q) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨vkâŸ©Q

  -- _áµ˜á´ºÂ»Ê°_ :  P  âŠ¢[ âˆ ][ i ]â‡›á´º  Q  â†’   Q  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  RË™  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©[ Îº ]  RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (PâŠ¢â‡›Q áµ˜á´ºÂ»Ê° QâŠ¢âŸ¨vkâŸ©R) =
    âŠ¢â‡›á´º-sem PâŠ¢â‡›Q â€º â‡›á´ºáµ’-mono (âŠ¢âºâŸ¨âŸ©áµ€-sem QâŠ¢âŸ¨vkâŸ©R) â€º â‡›á´ºáµ’-âºâŸ¨âŸ©áµ€áµ’

  -- _Ê°Â»áµ˜á´º_ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’
  --           (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ][ j ]â‡›á´º  RË™ v)  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (PâŠ¢âŸ¨vkâŸ©Q Ê°Â»áµ˜á´º QvâŠ¢â‡›Rv) =
    âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨vkâŸ©Q â€º âºâŸ¨âŸ©áµ€áµ’-mono (Î» v â†’ âŠ¢â‡›á´º-sem (QvâŠ¢â‡›Rv v)) â€º âºâŸ¨âŸ©áµ€áµ’-â‡›á´ºáµ’

  -- hor-frameË¡ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ]  QË™  â†’
  --               R  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€[ i ] Î» v â†’  R  âˆ—  QË™ v

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-frameË¡ PâŠ¢âŸ¨vkâŸ©Q) =  âˆ—áµ’-monoÊ³ (âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨vkâŸ©Q ) â€º âºâŸ¨âŸ©áµ€áµ’-eatË¡

  -- hor-valáµ˜á´º :  P  âŠ¢[ âˆ ][ i ]â‡›á´º  QË™ v  â†’   P  âŠ¢[ âˆ ]âºâŸ¨ T / Ä©â‚€ v âŸ©áµ€[ i ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-valáµ˜á´º PâŠ¢â‡›Qv) =  âŠ¢â‡›á´º-sem PâŠ¢â‡›Qv â€º âºâŸ¨âŸ©áµ€áµ’-val

  -- ahor-hor :  P âˆ— [âŠ¤]á´º  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ© (Î» v â†’  QË™ v âˆ— [âŠ¤]á´º)  â†’
  --             (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©áµ€[ j ]  RË™)  â†’
  --             P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (-, K , red) âŸ©áµ€[ j ]  RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (ahor-hor PâŠ¢âŸ¨redâŸ©á´ºQ QvâŠ¢âŸ¨KvâŸ©R) =  -âˆ—áµ’-intro (Î» _ â†’ âˆ—áµ’-comm â€º
    âŠ¢áµƒâŸ¨âŸ©-sem PâŠ¢âŸ¨redâŸ©á´ºQ â€º áµƒâŸ¨âŸ©áµ’-mono Î» v â†’ âˆ—áµ’-monoË¡ $ âŠ¢âºâŸ¨âŸ©áµ€-sem (QvâŠ¢âŸ¨KvâŸ©R v)) â€º
    áµƒâŸ¨âŸ©áµ’-âŸ¨âŸ©áµ€áµ’

  -- hor-bind :  P  âŠ¢[ âˆ ]âŸ¨ e âŸ©áµ€[ i ]  QË™  â†’
  --             (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©áµ€[ i ]  RË™)  â†’
  --             P  âŠ¢[ âˆ ]âŸ¨ K á´·â— e âŸ©áµ€[ i ]  RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-bind PâŠ¢âŸ¨eâŸ©Q QvâŠ¢âŸ¨KvâŸ©R) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨eâŸ©Q â€º
    âºâŸ¨âŸ©áµ€áµ’-mono (Î» v â†’ âŠ¢âºâŸ¨âŸ©áµ€-sem (QvâŠ¢âŸ¨KvâŸ©R v)) â€º âŸ¨âŸ©áµ€áµ’-bind

  -- hor-[] :  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— e âŸ©[ Îº ]  QË™  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (-, K , [ e ]á´¿) âŸ©[ Îº ]  QË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-[] PâŠ¢âŸ¨KeâŸ©Q) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨KeâŸ©Q â€º âºâŸ¨âŸ©áµ€áµ’-[]

  -- hor-fork :  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ _ âŸ©áµ€[ i ]  RË™  â†’
  --             Q  âŠ¢[ âˆ ]âŸ¨ e âŸ©áµ€[ i ] (Î» _ â†’  âŠ¤')  â†’
  --             P  âˆ—  Q  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (-, K , forká´¿ e) âŸ©áµ€[ i ]  RË™

  âŠ¢âºâŸ¨âŸ©áµ€-sem (hor-fork PâŠ¢âŸ¨KâŸ©R QâŠ¢âŸ¨eâŸ©) =
    âˆ—áµ’-mono (âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨KâŸ©R) (âŠ¢âºâŸ¨âŸ©áµ€-sem QâŠ¢âŸ¨eâŸ© â€º âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©áµ€áµ’âŠ¤) â€º âºâŸ¨âŸ©áµ€áµ’-fork

--------------------------------------------------------------------------------
-- âŠ¢âºâŸ¨âŸ©á´¾-sem :  Semantic soundness of the partial Hoare triple

abstract

  -- The metric of termination is the pair of the size Î¹ and the structure of
  -- the proof âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾; for â†ªâŸ¨âŸ©á´¾-use and horá´¾-â–¶, the proof structure does
  -- not decrease but the size âˆ does, which is the key trick.

  âŠ¢âºâŸ¨âŸ©á´¾-sem : P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  QË™  â†’   â¸¨ P â¸©  âŠ¨ âºâŸ¨ vk âŸ©á´¾áµ’ Î¹ Î» v â†’  â¸¨ QË™ v â¸©

  -- _Â»_ :  P âŠ¢[ âˆ ] Q â†’  Q âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾ RË™ â†’  P âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾ RË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (PâŠ¢Q Â» QâŠ¢âŸ¨vkâŸ©R) =
    âŠ¨âœ“â‡’âŠ¨-âºâŸ¨âŸ©á´¾áµ’ Î» âœ“âˆ™ â†’ âŠ¢-sem PâŠ¢Q âœ“âˆ™ â€º âŠ¢âºâŸ¨âŸ©á´¾-sem QâŠ¢âŸ¨vkâŸ©R

  -- âˆƒ-elim :  (âˆ€ x â†’  PË™ x âŠ¢[ âˆ ][ i ]â‡› Q) â†’  âˆƒË™ PË™ âŠ¢[ âˆ ][ i ]â‡› Q

  âŠ¢âºâŸ¨âŸ©á´¾-sem (âˆƒ-elim PxâŠ¢âŸ¨vkâŸ©Q) =   âˆ‘-case Î» x â†’ âŠ¢âºâŸ¨âŸ©á´¾-sem (PxâŠ¢âŸ¨vkâŸ©Q x)

  -- â†ªâŸ¨âŸ©á´¾-use :  e â‡’á´¾ e'  â†’
  --   PË‚ .!  âˆ—  (PË‚ â†ªâŸ¨ e' âŸ©á´¾ QË‚Ë™)  âŠ¢[ âˆ ]âŸ¨ e âŸ©á´¾ Î» v â†’  QË‚Ë™ v .!

  âŠ¢âºâŸ¨âŸ©á´¾-sem (â†ªâŸ¨âŸ©á´¾-use (redá´¾ eâ‡’K[eâ‚€])) big  rewrite eâ‡’K[eâ‚€] =
    âºâŸ¨âŸ©á´¾áµ’-[] Î»{ .! â†’ big â–· âˆ—áµ’-monoÊ³ (â†ªâŸ¨âŸ©áµ’-use â€º â‡›á´µâ¿áµˆâ‡’â‡›áµ’) â–· â‡›áµ’-eatË¡ â–·
    (â‡›áµ’-mono $ âˆ—áµ’âˆƒáµ’-out â€º Î» (-, big) â†’ âˆ—áµ’âˆƒáµ’-out big â–·
    Î» (Pâˆ—RâŠ¢âŸ¨eâŸ©Q , PRa) â†’ âŠ¢âºâŸ¨âŸ©á´¾-sem Pâˆ—RâŠ¢âŸ¨eâŸ©Q PRa) â–· â‡›áµ’-âºâŸ¨âŸ©á´¾áµ’ }

  -- _áµ˜á´ºÂ»Ê°_ :  P  âŠ¢[ âˆ ][ i ]â‡›á´º  Q  â†’   Q  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  RË™  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  RË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (PâŠ¢â‡›Q áµ˜á´ºÂ»Ê° QâŠ¢âŸ¨vkâŸ©R) =
    âŠ¢â‡›á´º-sem PâŠ¢â‡›Q â€º â‡›á´ºáµ’-mono (âŠ¢âºâŸ¨âŸ©á´¾-sem QâŠ¢âŸ¨vkâŸ©R) â€º â‡›á´ºáµ’-âºâŸ¨âŸ©á´¾áµ’

  -- _Ê°Â»áµ˜á´º_ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  QË™  â†’   (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ][ j ]â‡›á´º  RË™ v)  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  RË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (PâŠ¢âŸ¨vkâŸ©Q Ê°Â»áµ˜á´º QvâŠ¢â‡›Rv) =
    âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨vkâŸ©Q â€º âºâŸ¨âŸ©á´¾áµ’-mono (Î» v â†’ âŠ¢â‡›á´º-sem (QvâŠ¢â‡›Rv v)) â€º âºâŸ¨âŸ©á´¾áµ’-â‡›á´ºáµ’

  -- hor-áµ€â‡’á´¾ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©áµ€  QË™  â†’   P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-áµ€â‡’á´¾ PâŠ¢âŸ¨vkâŸ©Q) =  âŠ¢âºâŸ¨âŸ©áµ€-sem PâŠ¢âŸ¨vkâŸ©Q â€º âºâŸ¨âŸ©áµ€áµ’â‡’âºâŸ¨âŸ©á´¾áµ’

  -- hor-frameË¡ :  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾  QË™  â†’
  --               R  âˆ—  P  âŠ¢[ âˆ ]âºâŸ¨ vk âŸ©á´¾ Î» v â†’  R  âˆ—  QË™ v

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-frameË¡ PâŠ¢âŸ¨vkâŸ©Q) =  âˆ—áµ’-monoÊ³ (âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨vkâŸ©Q ) â€º âºâŸ¨âŸ©á´¾áµ’-eatË¡

  -- hor-valáµ˜á´º :  P  âŠ¢[ âˆ ][ i ]â‡›á´º  QË™ v  â†’   P  âŠ¢[ âˆ ]âºâŸ¨ T / Ä©â‚€ v âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-valáµ˜á´º PâŠ¢â‡›Qv) =  âŠ¢â‡›á´º-sem PâŠ¢â‡›Qv â€º âºâŸ¨âŸ©á´¾áµ’-val

  -- ahor-hor :  P âˆ— [âŠ¤]á´º  âŠ¢[ âˆ ][ i ]áµƒâŸ¨ red âŸ© (Î» v â†’  QË™ v âˆ— [âŠ¤]á´º)  â†’
  --             (âˆ€ v â†’  QË™ v  âŠ¢[< âˆ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©á´¾  RË™)  â†’
  --             P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (-, K , red) âŸ©á´¾  RË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (ahor-hor PâŠ¢âŸ¨redâŸ©á´ºQ QvâŠ¢âŸ¨KvâŸ©R) =  -âˆ—áµ’-intro (Î» _ â†’ âˆ—áµ’-comm â€º
    âŠ¢áµƒâŸ¨âŸ©-sem PâŠ¢âŸ¨redâŸ©á´ºQ â€º áµƒâŸ¨âŸ©áµ’-mono Î» v â†’ âˆ—áµ’-monoË¡ Î» big â†’
    Î»{ .! â†’ big â–· âŠ¢âºâŸ¨âŸ©á´¾-sem (QvâŠ¢âŸ¨KvâŸ©R v .!) }) â€º áµƒâŸ¨âŸ©áµ’-âŸ¨âŸ©á´¾áµ’

  -- hor-bind :  P  âŠ¢[ âˆ ]âŸ¨ e âŸ©á´¾  QË™  â†’
  --             (âˆ€ v â†’  QË™ v  âŠ¢[ âˆ ]âŸ¨ K á´·â— Vâ‡’E v âŸ©á´¾  RË™)  â†’
  --             P  âŠ¢[ âˆ ]âŸ¨ K á´·â— e âŸ©á´¾  RË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-bind PâŠ¢âŸ¨eâŸ©Q QvâŠ¢âŸ¨KvâŸ©R) =  âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨eâŸ©Q â€º
    âºâŸ¨âŸ©á´¾áµ’-mono (Î» v â†’ âŠ¢âºâŸ¨âŸ©á´¾-sem (QvâŠ¢âŸ¨KvâŸ©R v)) â€º âŸ¨âŸ©á´¾áµ’-bind

  -- hor-[] :  P  âŠ¢[< âˆ ]âŸ¨ K á´·â— e âŸ©á´¾  QË™  â†’
  --           P  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (-, K , [ e ]á´¿) âŸ©á´¾  QË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-[] PâŠ¢âŸ¨KeâŸ©Q) Pa =  âºâŸ¨âŸ©á´¾áµ’-[] Î»{ .! â†’ âŠ¢âºâŸ¨âŸ©á´¾-sem (PâŠ¢âŸ¨KeâŸ©Q .!) Pa }

  -- hor-fork :  P  âŠ¢[ âˆ ]âŸ¨ K á´·â— âˆ‡ _ âŸ©á´¾  RË™  â†’
  --             Q  âŠ¢[ âˆ ]âŸ¨ e âŸ©á´¾ (Î» _ â†’  âŠ¤')  â†’
  --             P  âˆ—  Q  âŠ¢[ âˆ ]âºâŸ¨ Ä©â‚ (-, K , forká´¿ e) âŸ©á´¾  RË™

  âŠ¢âºâŸ¨âŸ©á´¾-sem (hor-fork PâŠ¢âŸ¨KâŸ©R QâŠ¢âŸ¨eâŸ©) =
    âˆ—áµ’-mono (âŠ¢âºâŸ¨âŸ©á´¾-sem PâŠ¢âŸ¨KâŸ©R) (âŠ¢âºâŸ¨âŸ©á´¾-sem QâŠ¢âŸ¨eâŸ© â€º âºâŸ¨âŸ©á´¾áµ’â‡’âºâŸ¨âŸ©á´¾áµ’âŠ¤) â€º âºâŸ¨âŸ©á´¾áµ’-fork
